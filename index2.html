<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptMana</title>
    <!-- Carregando Tailwind CSS e Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Bibliotecas Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                },
            },
        }
    </script>
    <style>
        :root {
            --bg-dark: #121212; /* Cinza mais escuro */
            --card-bg-dark: #1E1E1E; /* Fundo do card mais escuro */
            --border-dark: #2E2E2E; /* Borda mais escura */
            --text-dark: #FFFDF2; /* Creme */
            --text-muted-dark: #808080; /* Cinza de texto mais escuro */
            --accent-fuchsia: #D8125B;
            --accent-fuchsia-hover: #b80f4d;
            --accent-mint: #0FFCBE;
            --accent-red: #dc2626;
            --accent-red-hover: #b91c1c;
            --diff-ins-bg: #517A18;
            --diff-del-bg: #CC5E5E;
            --highlight-bg: rgba(216, 18, 91, 0.4); /* Cor de destaque para busca */
        }
        
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--bg-dark); color: var(--text-dark); font-family: 'Inter', sans-serif; }
        #root { height: 100vh; }
        .sidebar { width: 320px; min-width: 320px; background-color: var(--card-bg-dark); border-right: 1px solid var(--border-dark); }
        .action-panel { width: 320px; min-width: 320px; background-color: var(--card-bg-dark); border-left: 1px solid var(--border-dark); }
        .main-editor-area { background-color: var(--bg-dark); }
        .editor-window { background-color: var(--card-bg-dark); border: 1px solid var(--border-dark); border-radius: 0.75rem; }
        .form-input, .llm-select { background-color: transparent; border: 0; color: var(--text-dark); }
        .form-input::placeholder { color: var(--text-muted-dark); }
    .form-input:focus, .llm-select:focus { outline: none; box-shadow: none; }
        
        .action-button { background-color: transparent; border: 1px solid var(--border-dark); font-size: 0.875rem; padding: 6px 12px; border-radius: 0.5rem; transition: background-color 0.2s, border-color 0.2s; }
        .action-button:hover { background-color: #333333; border-color: #444444; }
        .action-button:disabled { cursor: not-allowed; opacity: 0.5; }
        .action-button.primary { background-color: var(--accent-fuchsia); border-color: var(--accent-fuchsia-hover); color: white; }
        .action-button.primary:hover { background-color: var(--accent-fuchsia-hover); }
        .action-button.active {
            background-color: var(--accent-fuchsia);
            color: white;
            border-color: var(--accent-fuchsia-hover);
        }
        
        .prompt-group-header { cursor: pointer; padding: 8px; border-radius: 0.5rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.875rem; font-weight: 500; }
        .prompt-group-header:hover { background-color: #333333; }
        .prompt-group-header .toggle-icon { margin-right: 8px; transition: transform 0.2s; color: var(--text-muted-dark); }
        .prompt-group-header.expanded .toggle-icon { transform: rotate(90deg); }

        .version-sub-list { padding-left: 12px; display: none; }
        .version-sub-list.expanded { display: block; }
        .version-item { cursor: pointer; padding: 6px 12px; border-radius: 0.5rem; transition: background-color 0.2s; display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .version-item:hover { background-color: #333333; }
        .version-item.selected { background-color: var(--accent-fuchsia); color: white; }
        .version-item.selected .text-gray-400, .version-item.selected .text-gray-500 { color: white; }

        .status-selector { background-color: #333333; border: 1px solid var(--border-dark); }
        .status-option { border-right: 1px solid var(--border-dark); color: var(--text-muted-dark); transition: all 0.2s; }
        .status-option:last-child { border-right: none; }
        .status-option:hover { color: var(--text-dark); }
        .status-option.active { background-color: var(--accent-fuchsia); color: white; font-weight: 600; }

        /* Estilo unificado para botões de filtro (status e tags) */
        .filter-tag-btn {
            background-color: #333;
            color: var(--text-muted-dark);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            border: 1px solid var(--border-dark);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-tag-btn:hover {
            color: var(--text-dark);
            background-color: #444444;
        }
        .filter-tag-btn.active {
            background-color: var(--accent-fuchsia);
            color: white;
            border-color: var(--accent-fuchsia-hover);
        }

        #editor-stats { color: var(--accent-mint); }

        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-overlay.hidden { opacity: 0; pointer-events: none; }
        #confirm-modal { z-index: 60; } /* Z-index maior para o modal de confirmação */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75) !important;
        }

        .modal-overlay > div {
            background-color: var(--card-bg-dark) !important;
            border: 1px solid var(--border-dark) !important;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            color: var(--text-dark);
        }
        
        .form-control {
            background-color: #222222;
            border: 1px solid #3a3a3a;
        }
        .form-control:focus, #search-versions-input:focus {
            --tw-ring-color: #444444;
            border-color: #555555;
        }

        /* Custom Range Slider Styles */
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #333; border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-fuchsia); cursor: pointer; border-radius: 50%; }
        input[type=range]::-moz-range-thumb { width: 16px; height: 16px; background: var(--accent-fuchsia); cursor: pointer; border-radius: 50%; }

        .xml-tag, .dependency-tag, .var-library-tag {
            background-color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .xml-tag:hover, .dependency-tag:hover, .var-library-tag:hover {
            background-color: var(--accent-fuchsia);
        }
        .gallery-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .gallery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(216, 18, 91, 0.1), 0 4px 6px -2px rgba(216, 18, 91, 0.05);
        }
        .read-mode-blur {
            filter: blur(5px);
            transition: filter 0.3s ease-in-out;
        }
        .diff-view del {
            background-color: var(--diff-del-bg);
            text-decoration: none;
            padding: 0.1em 0;
            border-radius: 2px;
        }
        .diff-view ins {
            background-color: var(--diff-ins-bg);
            text-decoration: none;
            padding: 0.1em 0;
            border-radius: 2px;
        }
        #find-replace-bar {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            padding: 0;
            border-bottom: 0px solid var(--border-dark);
        }
        #find-replace-bar.visible {
             max-height: 100px; /* Altura suficiente para o conteúdo */
             padding: 0.5rem;
             border-bottom-width: 1px;
        }
        textarea::selection {
            background-color: var(--accent-fuchsia);
            color: white;
        }
        .highlight {
            background-color: var(--highlight-bg);
        }
        /* Estilos para o Gráfico de Dependências */
        #dependency-graph-svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #dependency-graph-svg:active {
            cursor: grabbing;
        }
        .graph-node {
             cursor: pointer;
        }
        .graph-node circle {
            stroke: var(--accent-fuchsia);
            stroke-width: 1.5px;
            transition: transform 0.2s, stroke-width 0.2s;
        }
        .graph-node:hover circle {
            transform: scale(1.2);
            stroke-width: 3px;
        }
        .graph-node.selected-for-connection circle {
            stroke: var(--accent-mint);
            stroke-width: 4px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .graph-node text {
            fill: var(--text-dark);
            font-size: 10px;
            pointer-events: none;
            text-anchor: middle;
            font-family: 'Inter', sans-serif;
        }
        .graph-link {
            stroke: var(--border-dark);
            stroke-opacity: 0.7;
            stroke-width: 1.5px;
            transition: stroke 0.2s, stroke-width 0.2s;
        }
        .graph-link:hover {
            stroke-width: 3px;
        }
        .graph-link.selected {
            stroke: var(--accent-red);
            stroke-width: 4px;
        }
        #graph-tooltip {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-dark);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.75rem;
            min-width: 250px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.25);
            z-index: 100;
        }
        /* Estilos para Tags */
        .prompt-tag, .manager-tag {
            background-color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'Roboto Mono', monospace;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .manager-tag span[contenteditable]:focus {
            outline: 1px solid var(--accent-fuchsia);
            background-color: #444;
        }
        .prompt-tag .remove-tag-btn, .manager-tag .remove-tag-btn {
            cursor: pointer;
            color: var(--text-muted-dark);
        }
        .prompt-tag .remove-tag-btn:hover, .manager-tag .remove-tag-btn:hover {
            color: var(--accent-red);
        }
        .prompt-tag.auto-tag {
            background-color: #2a2a2a;
            color: var(--text-muted-dark);
        }
        /* Dropdown customizado */
        .custom-dropdown {
            position: absolute;
            z-index: 10;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-dark);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .custom-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.875rem;
        }
        .custom-dropdown-item:hover {
            background-color: var(--accent-fuchsia);
            color: white;
        }
        /* Estilos do Mapa de Navegação */
        #navigation-map {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .nav-map-tag {
            background-color: #333;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'Roboto Mono', monospace;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid var(--border-dark);
        }
        .nav-map-tag:hover {
            background-color: var(--accent-fuchsia);
            color: white;
        }
        /* Estilos para a lista da galeria de inputs */
        .input-gallery-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .input-gallery-item:hover {
            background-color: #333;
        }
        .input-gallery-item.selected {
            background-color: var(--accent-fuchsia);
            color: white;
        }
        .input-gallery-item .remove-btn {
            visibility: hidden;
            color: var(--text-muted-dark);
        }
        .input-gallery-item:hover .remove-btn {
            visibility: visible;
        }
        .input-gallery-item .remove-btn:hover {
            color: var(--accent-red);
        }
        /* Estilos para Snippet Copy Button */
        #editor-container {
            overflow: hidden; /* Garante que os botões não saiam da área */
        }
        #snippet-buttons-overlay {
            pointer-events: none; /* O overlay em si não é clicável */
        }
        .copy-snippet-btn {
            position: absolute;
            pointer-events: all; /* Torna o botão clicável */
            background-color: #333;
            color: var(--text-muted-dark);
            border: 1px solid var(--border-dark);
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 5; /* Garante que fique sobre o texto */
        }
        .copy-snippet-btn:hover {
            background-color: var(--accent-fuchsia);
            color: white;
        }
        .copy-snippet-btn.copied {
            background-color: var(--diff-ins-bg);
            color: white;
            border-color: #3f6212;
        }
        
        /* --- ESTILOS NODE FLOW --- */
        #node-flow-canvas {
            background-color: #0c0c0c;
            background-image:
                radial-gradient(circle, rgba(255,255,255,0.07) 1px, transparent 1px);
            background-size:
                16px 16px; /* pontos */
            background-position:
                0 0, 0 0, 0 0;
            overflow: hidden;
            position: relative;
        }
        #node-flow-canvas:active {
            cursor: grabbing;
        }
        .node-flow-prompt-card {
            background-color: var(--card-bg-dark);
            border: 1px solid var(--border-dark);
            cursor: grab;
        }
        .node-flow-prompt-card:active {
            cursor: grabbing;
        }
        #node-flow-content {
            position: absolute;
            width: 100%;
            height: 100%;
            /* O transform será aplicado via JS */
        }
        .flow-node {
            position: absolute;
            border: 1px solid var(--border-dark);
            background-color: var(--card-bg-dark); /* Adicionado fundo ao card */
            cursor: move;
            width: 280px; /* Largura fixa para consistência */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            user-select: none;
            transition: border-color 0.2s;
        }
        .flow-node:hover {
            border-color: var(--accent-fuchsia);
        }
        .flow-node .connector {
            position: absolute;
            width: 14px;
            height: 14px;
            background-color: #444;
            border: 1px solid var(--text-muted-dark);
            border-radius: 50%;
            cursor: crosshair;
            transition: background-color 0.2s, transform 0.2s;
            z-index: 10;
        }
        .flow-node:hover .connector {
            transform: scale(1.2);
        }
        .flow-node .connector:hover {
            background-color: var(--accent-mint);
        }
        .flow-node .connector.output {
            right: -7px;
            top: 50%;
            transform: translateY(-50%);
        }
        #node-flow-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .connection-line {
            stroke: var(--accent-fuchsia);
            stroke-width: 2;
            fill: none;
            pointer-events: auto; /* Permite clicar na linha */
            cursor: pointer;
        }
        .connection-line:hover {
            stroke-width: 4;
            stroke: var(--accent-red);
        }
    </style>
</head>
<body>

    <div id="root" class="flex flex-col h-screen">
        <header id="main-header" class="bg-[--card-bg-dark] border-b border-[--border-dark] px-6 py-2 flex items-center justify-between relative z-20">
            <div class="flex items-center gap-3">
                <!-- LOGO SVG -->
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(15deg);">
                    <path d="M9 21C9 21.5523 8.55228 22 8 22H7C6.44772 22 6 21.5523 6 21V20H9V21Z" fill="#5A5A5A"/>
                    <path d="M10 4H14C14.5523 4 15 3.55228 15 3V2C15 1.44772 14.5523 1 14 1H10C9.44772 1 9 1.44772 9 2V3C9 3.55228 9.44772 4 10 4Z" fill="#A8763E"/>
                    <path d="M17 9V8C17 6.34315 15.6569 5 14 5H10C8.34315 5 7 6.34315 7 8V9C4.23858 9 2 11.2386 2 14V17C2 19.2091 3.79086 21 6 21H9V20H6C4.34315 20 3 18.6569 3 17V14C3 11.7909 4.79086 10 7 10H17C19.2091 10 21 11.7909 21 14V17C21 18.6569 19.6569 20 18 20H15V21H18C20.2091 21 22 19.2091 22 17V14C22 11.2386 19.7614 9 17 9Z" fill="#5A5A5A"/>
                    <path d="M18 11H6C5.44772 11 5 11.4477 5 12V17C5 18.1046 5.89543 19 7 19H17C18.1046 19 19 18.1046 19 17V12C19 11.4477 18.5523 11 18 11Z" fill="url(#potion-gradient)"/>
                    <defs>
                        <linearGradient id="potion-gradient" x1="12" y1="11" x2="12" y2="19" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#D8125B"/>
                            <stop offset="1" stop-color="#F871B1"/>
                        </linearGradient>
                    </defs>
                </svg>
                <h1 class="text-xl font-bold font-mono" style="color: var(--accent-fuchsia);">PromptMana</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="read-mode-btn" title="Read Mode" class="p-2 rounded-full hover:bg-[#333]">
                    <!-- Olho Fechado (Padrão) -->
                    <svg id="read-mode-icon-closed" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243a3 3 0 01-4.243-4.243" />
                    </svg>
                    <!-- Olho Aberto (Oculto) -->
                    <svg id="read-mode-icon-open" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <div id="main-content" class="flex flex-grow overflow-hidden transition-filter duration-300">
            <!-- PAINEL ESQUERDO -->
            <aside class="sidebar p-4 flex flex-col space-y-4">
                 <button id="add-prompt-btn" class="action-button primary w-full text-center font-medium py-2">Add Prompt</button>
                 <hr class="border-[--border-dark]">
                 <div class="space-y-2">
                     <button id="templates-btn" class="action-button w-full text-left font-medium">Templates</button>
                     <button id="projects-btn" class="action-button w-full text-left font-medium">Projects</button>
                     <button id="gallery-btn" class="action-button w-full text-left font-medium">Prompt Gallery</button>
                     <button id="input-gallery-btn" class="action-button w-full text-left font-medium">Input Gallery</button>
                     <button id="list-manager-btn" class="action-button w-full text-left font-medium">List Manager</button>
                 </div>
                 <hr class="border-[--border-dark]">
                 <button id="node-flow-btn" class="action-button w-full text-left font-medium">Node Flow</button>
                 <button id="graph-view-btn" class="action-button w-full text-left font-medium">Graph View</button>
                 <hr class="border-[--border-dark]">
                
                 <!-- Seção de Versões e Filtros Reorganizada -->
                 <div class="flex flex-col flex-grow overflow-hidden">
                     <div class="flex justify-between items-center mb-3">
                         <h2 class="text-base font-semibold">Versions</h2>
                         <button id="compare-versions-btn" class="action-button text-xs" disabled>Compare</button>
                     </div>

                     <!-- Container de Filtros Unificado -->
                     <div id="filters-container" class="space-y-3 mb-3 flex-shrink-0">
                         <div class="relative">
                             <input id="search-versions-input" placeholder="Search by title, project or #tag..." class="form-control w-full rounded-md py-1.5 px-3 text-sm focus:ring-2">
                         </div>
                         <div id="status-filter-container" class="flex flex-wrap gap-2">
                             <button class="filter-tag-btn active" data-filter="all">All</button>
                             <button class="filter-tag-btn" data-filter="write">Write</button>
                             <button class="filter-tag-btn" data-filter="test">Test</button>
                             <button class="filter-tag-btn" data-filter="edit">Edit</button>
                             <button class="filter-tag-btn" data-filter="use">Use</button>
                         </div>
                     </div>

                     <hr class="border-[--border-dark] mb-3">

                     <!-- Lista de Versões -->
                     <div id="versions-history-list" class="flex-grow overflow-y-auto space-y-1 pr-2">
                         <!-- Lista hierárquica de versões será inserida aqui -->
                     </div>
                 </div>
            </aside>

            <!-- Área Principal de Edição -->
            <main class="flex-grow p-6 flex flex-col main-editor-area">
                <!-- Managers Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <!-- XML Tag Manager -->
                    <div class="p-4 bg-[--card-bg-dark] border border-[--border-dark] rounded-lg">
                        <label class="text-base font-semibold mb-2 block">XML Tag Manager</label>
                        <div class="relative flex gap-2">
                            <input id="xml-tag-input" type="text" placeholder="Search or create tag..." class="w-full rounded-md py-1 px-2 text-sm form-control" autocomplete="off">
                            <button id="add-xml-tag-btn" class="action-button primary px-3">+</button>
                            <div id="xml-tag-dropdown" class="custom-dropdown hidden"></div>
                        </div>
                    </div>
                    <!-- Var Library -->
                    <div class="p-4 bg-[--card-bg-dark] border border-[--border-dark] rounded-lg">
                        <label class="text-base font-semibold mb-2 block">Var Library</label>
                         <div class="relative flex gap-2">
                            <input id="var-library-input" type="text" placeholder="Search or create variable..." class="w-full rounded-md py-1 px-2 text-sm form-control" autocomplete="off">
                            <button id="add-var-library-btn" class="action-button primary px-3">+</button>
                            <div id="var-library-dropdown" class="custom-dropdown hidden"></div>
                        </div>
                    </div>
                    <!-- Add Input -->
                    <div class="p-4 bg-[--card-bg-dark] border border-[--border-dark] rounded-lg">
                        <label class="text-base font-semibold mb-2 block">Add Input</label>
                         <div class="relative flex gap-2">
                            <input id="add-input-input" type="text" placeholder="Search input..." class="w-full rounded-md py-1 px-2 text-sm form-control" autocomplete="off">
                            <div id="add-input-dropdown" class="custom-dropdown hidden"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Mapa de Navegação -->
                <div id="navigation-map" class="mb-4 p-2 bg-[--card-bg-dark] border border-[--border-dark] rounded-lg hidden"></div>

                <div class="editor-window flex-grow flex flex-col">
                    <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                        <div class="flex items-center flex-grow">
                            <input id="prompt-title-input" placeholder="Your prompt title..." class="form-input font-mono w-full px-2 py-2 text-2xl font-medium">
                            <button id="copy-prompt-btn" title="Copy prompt content" class="ml-2 p-2 rounded-md text-[--text-muted-dark] hover:text-white hover:bg-[#333]">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <button id="find-btn" title="Find and Replace (Ctrl+F)" class="p-2 rounded-md text-[--text-muted-dark] hover:text-white hover:bg-[#333]">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </button>
                        <button id="toggle-comments-btn" title="Comments" class="p-2 rounded-md text-[--text-muted-dark] hover:text-white hover:bg-[#333]">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Find and Replace Bar -->
                    <div id="find-replace-bar">
                        <div class="grid grid-cols-2 gap-2">
                            <input id="find-input" type="text" placeholder="Find..." class="form-control text-xs rounded-md py-1 px-2">
                            <input id="replace-input" type="text" placeholder="Replace with..." class="form-control text-xs rounded-md py-1 px-2">
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <span id="find-counter" class="text-xs font-mono text-[--text-muted-dark]">0/0</span>
                            <button id="prev-btn" class="action-button text-xs p-1" disabled>Previous</button>
                            <button id="next-btn" class="action-button text-xs p-1" disabled>Next</button>
                            <button id="replace-btn" class="action-button text-xs" disabled>Replace</button>
                            <button id="replace-all-btn" class="action-button text-xs" disabled>Replace All</button>
                            <button id="close-find-btn" class="action-button text-xs p-1 ml-auto">&times;</button>
                        </div>
                    </div>
                    <div class="flex-grow p-1 relative" id="editor-container">
                        <textarea id="main-editor" placeholder="Have a new big idea to change the world with your prompt? 
Write, right here, right now. Show me your mana!" class="form-input font-mono w-full h-full p-4 text-base leading-relaxed resize-none"></textarea>
                        <div id="snippet-buttons-overlay" class="absolute top-0 left-0 w-full h-full p-4 pointer-events-none"></div>
                    </div>
                    <!-- Barra de Dependência -->
                    <div id="dependency-bar" class="p-2 border-t border-[--border-dark] hidden">
                        <div id="dependency-tag-container" class="flex items-center gap-2">
                             <!-- Tag de dependência será inserida aqui -->
                        </div>
                    </div>
                    <!-- Seção de Variáveis -->
                     <div id="variables-section" class="p-4 border-t border-[--border-dark] hidden">
                         <h3 class="text-sm font-bold text-[--text-muted-dark] mb-2">Prompt Variables</h3>
                         <div id="variables-container" class="space-y-2"></div>
                     </div>
                    <!-- Seção de Comentários -->
                    <div id="comments-section" class="p-4 border-t border-[--border-dark] hidden">
                        <h3 class="text-sm font-bold text-[--text-muted-dark] mb-2">Version Comments</h3>
                        <textarea id="comments-textarea" placeholder="Note the purpose of the version, tests, results..." class="form-input font-sans w-full h-24 p-2 text-sm leading-relaxed resize-none bg-[#222222] rounded-md"></textarea>
                    </div>
                     <div class="flex items-center justify-between p-2 border-t border-[--border-dark]">
                         <div id="status-selector-container" class="flex items-center justify-center">
                             <div class="status-selector flex rounded-lg overflow-hidden">
                                 <button class="status-option px-4 py-1.5 text-sm" data-status="write">Write</button>
                                 <button class="status-option px-4 py-1.5 text-sm" data-status="test">Test</button>
                                 <button class="status-option px-4 py-1.5 text-sm" data-status="edit">Edit</button>
                                 <button class="status-option px-4 py-1.5 text-sm" data-status="use">Use</button>
                             </div>
                         </div>
                         <div id="editor-stats" class="text-xs font-mono pr-4">0 tokens / 0 words / 0 characters</div>
                     </div>
                </div>
            </main>

            <!-- Painel de Ações (Direita) -->
            <aside class="action-panel p-4 flex flex-col">
                <div class="flex-grow overflow-y-auto pr-2">
                    <div class="space-y-3">
                        <button id="add-major-version-btn" class="action-button primary w-full text-left font-medium">Save Major Version</button>
                        <button id="add-minor-version-btn" class="action-button w-full text-left font-medium">Save New Version</button>
                        <button id="save-changes-btn" class="action-button w-full text-left font-medium">Save Changes</button>
                        <button id="save-as-template-btn" class="action-button w-full text-left font-medium">Save as Template</button>
                        <button id="fork-version-btn" class="action-button w-full text-left font-medium">Fork Version</button>
                        <button id="delete-version-btn" class="action-button w-full text-left font-medium text-red-500 hover:bg-red-900/20 hover:border-red-800">Delete Version</button>
                        <hr class="border-[--border-dark] my-1">
                         <div>
                             <label for="project-name-input-aside" class="text-xs font-medium text-[--text-muted-dark]">Project</label>
                             <input id="project-name-input-aside" list="project-list-aside" placeholder="Select or create..." class="form-control w-full mt-1 rounded-md py-1.5 px-3 text-sm focus:ring-2">
                             <datalist id="project-list-aside"></datalist>
                         </div>
                        <div>
                            <label for="dependency-select" class="text-xs font-medium text-[--text-muted-dark]">Dependence/Relation</label>
                            <select id="dependency-select" class="form-control w-full mt-1 rounded-md py-1.5 px-3 text-sm focus:ring-2">
                                <option value="">No dependency</option>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="llm-select" class="text-xs font-medium text-[--text-muted-dark]">Target LLM</label>
                            <select id="llm-select" class="form-control w-full mt-1 rounded-md py-1.5 px-3 text-sm focus:ring-2">
                                <option value="generic">Unspecified</option>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <!-- Tags -->
                        <div>
                            <label for="tags-input-aside" class="text-xs font-medium text-[--text-muted-dark]">Tags</label>
                            <div class="relative">
                                <input id="tags-input-aside" type="text" placeholder="Search or add tag..." class="form-control w-full mt-1 rounded-md py-1.5 px-3 text-sm focus:ring-2" autocomplete="off">
                                <div id="tags-dropdown-aside" class="custom-dropdown hidden"></div>
                            </div>
                            <div id="tags-container-aside" class="flex flex-wrap gap-2 mt-3 max-h-24 overflow-y-auto">
                                <!-- Tags for the current prompt will be inserted here -->
                            </div>
                        </div>
                        <!-- Parâmetros -->
                        <div>
                            <div class="flex justify-between items-center text-xs font-medium text-[--text-muted-dark]">
                                <label for="temperature-slider">Temperature</label>
                                <span id="temperature-value" class="font-mono">0.7</span>
                            </div>
                            <input id="temperature-slider" type="range" min="0" max="2" step="0.1" value="0.7">
                        </div>
                         <div>
                            <div class="flex justify-between items-center text-xs font-medium text-[--text-muted-dark]">
                                <label for="top-p-slider">Top P</label>
                                <span id="top-p-value" class="font-mono">0.90</span>
                            </div>
                            <input id="top-p-slider" type="range" min="0" max="1" step="0.01" value="0.9">
                        </div>
                         <div>
                            <div class="flex justify-between items-center text-xs font-medium text-[--text-muted-dark]">
                                <label for="effort-slider">Effort</label>
                                <span id="effort-value" class="font-mono">Medium</span>
                            </div>
                            <input id="effort-slider" type="range" min="0" max="2" step="1" value="1">
                        </div>
                    </div>
                </div>
                <div class="mt-auto">
                    <hr class="border-[--border-dark] my-3">
                    <button id="download-json-btn" class="action-button primary w-full text-left font-medium">Json Download</button>
                    <button id="download-md-btn" class="action-button primary w-full text-left font-medium mt-2">Markdown Download</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-[--card-bg-dark] p-6 rounded-lg shadow-xl max-w-sm w-full border border-[--border-dark]">
            <h3 id="confirm-modal-title" class="text-lg font-bold mb-4"></h3>
            <p id="confirm-modal-text" class="text-[--text-muted-dark] mb-6"></p>
            <div id="confirm-modal-input-container" class="mb-4 hidden">
                <input id="confirm-modal-input" type="text" class="form-control w-full rounded-md py-1.5 px-3 text-sm">
            </div>
            <div id="confirm-modal-buttons" class="flex justify-end gap-4">
                <!-- Botões do modal serão inseridos aqui -->
            </div>
        </div>
    </div>
    
    <!-- Modal da Galeria -->
    <div id="gallery-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 class="text-xl font-bold">Gallery</h2>
                <button id="close-gallery-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="gallery-grid" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto">
                <!-- Cards da galeria serão inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Projetos -->
    <div id="projects-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 class="text-xl font-bold">Projects</h2>
                <div class="flex items-center gap-4">
                    <button id="add-project-btn" class="action-button primary text-sm">Add Project</button>
                    <button id="close-projects-btn" class="p-2 rounded-full hover:bg-[#333]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="projects-list-container" class="p-6 overflow-y-auto">
                <!-- Lista de projetos será inserida aqui -->
            </div>
            <div id="add-project-popup" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-[--card-bg-dark] p-6 rounded-lg shadow-xl max-w-sm w-full border border-[--border-dark]">
                    <h3 class="text-lg font-bold mb-4">Add New Project</h3>
                    <p class="text-[--text-muted-dark] mb-6">Enter the name of the new project:</p>
                    <input id="new-project-name-input" type="text" placeholder="Project name..." class="form-control w-full rounded-md py-1.5 px-3 text-sm mb-4">
                    <div class="flex justify-end gap-4">
                        <button id="cancel-add-project-btn" class="action-button">Cancel</button>
                        <button id="confirm-add-project-btn" class="action-button primary">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Templates -->
    <div id="templates-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 class="text-xl font-bold">Templates</h2>
                <button id="close-templates-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="templates-grid-container" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto">
                <!-- Cards de templates serão inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- Modal Visualizador de Dependência -->
    <div id="dependency-viewer-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-4xl h-full max-h-[80vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 id="dependency-viewer-title" class="text-xl font-bold">Dependency Viewer</h2>
                <button id="close-dependency-viewer-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <pre id="dependency-viewer-content" class="text-sm font-mono whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>

    <!-- Modal Visualizador de Comentários -->
    <div id="comments-viewer-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-2xl rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 id="comments-viewer-title" class="text-xl font-bold">Comments</h2>
                <button id="close-comments-viewer-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <pre id="comments-viewer-content" class="text-sm font-sans whitespace-pre-wrap leading-relaxed"></pre>
            </div>
        </div>
    </div>

    <!-- Modal Read Mode -->
    <div id="read-mode-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center hidden z-50 p-8 cursor-pointer">
        <pre id="read-mode-content" class="w-full max-w-4xl h-full max-h-[90vh] text-[--text-dark] p-8 overflow-y-auto font-mono text-lg leading-relaxed whitespace-pre-wrap cursor-default"></pre>
    </div>

    <!-- Modal Comparador de Versões -->
    <div id="diff-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 id="diff-modal-title" class="text-xl font-bold">Comparing Versions</h2>
                <button id="close-diff-modal-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-grow grid grid-cols-2 gap-4 p-4 overflow-y-auto">
                <div class="diff-view bg-[#121212] p-4 rounded-md font-mono text-sm whitespace-pre-wrap"><h3 id="diff-title-a" class="font-bold text-lg mb-2"></h3><hr class="border-[--border-dark] my-2"><div id="diff-panel-a"></div></div>
                <div class="diff-view bg-[#121212] p-4 rounded-md font-mono text-sm whitespace-pre-wrap"><h3 id="diff-title-b" class="font-bold text-lg mb-2"></h3><hr class="border-[--border-dark] my-2"><div id="diff-panel-b"></div></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Gráfico de Dependências -->
    <div id="dependency-graph-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 class="text-xl font-bold">Graph View</h2>
                <button id="close-dependency-graph-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Seção de Filtros do Gráfico -->
            <div id="graph-filters" class="p-4 border-b border-[--border-dark] flex items-end gap-4 flex-shrink-0">
                <div>
                    <label for="graph-project-filter" class="text-xs font-medium text-[--text-muted-dark]">Filter by Project:</label>
                    <select id="graph-project-filter" class="form-control w-full mt-1 rounded-md py-1.5 px-3 text-sm focus:ring-2">
                        <!-- Opções populadas via JS -->
                    </select>
                </div>
                <button id="create-connection-btn" class="action-button text-sm">Create Connection</button>
                <button id="delete-connection-btn" class="action-button text-sm" disabled>Delete Connection</button>
            </div>
            <div class="flex-grow p-4 overflow-hidden relative">
                <svg id="dependency-graph-svg"></svg>
                <div id="graph-tooltip"></div>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciador de Listas -->
    <div id="list-manager-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center">
                <h2 class="text-xl font-bold">List Manager</h2>
                <button id="close-list-manager-btn" class="p-2 rounded-full hover:bg-[#333]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 overflow-hidden">
                <!-- Coluna XML Tags -->
                <div class="flex flex-col gap-3 p-3 bg-[#121212] rounded-md overflow-hidden">
                    <h3 class="font-semibold flex-shrink-0">XML Tags</h3>
                    <div class="flex gap-2 flex-shrink-0">
                        <input id="add-xml-tag-manager-input" type="text" placeholder="New XML tag..." class="form-control w-full rounded-md py-1 px-2 text-sm">
                        <button id="add-xml-tag-manager-btn" class="action-button primary px-3">+</button>
                    </div>
                    <div id="xml-tags-manager-container" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                </div>
                <!-- Coluna Var Library -->
                <div class="flex flex-col gap-3 p-3 bg-[#121212] rounded-md overflow-hidden">
                    <h3 class="font-semibold flex-shrink-0">Variables (Var Library)</h3>
                    <div class="flex gap-2 flex-shrink-0">
                        <input id="add-var-library-manager-input" type="text" placeholder="New variable..." class="form-control w-full rounded-md py-1 px-2 text-sm">
                        <button id="add-var-library-manager-btn" class="action-button primary px-3">+</button>
                    </div>
                    <div id="var-library-manager-container" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                </div>
                <!-- Coluna Tags Gerais -->
                <div class="flex flex-col gap-3 p-3 bg-[#121212] rounded-md overflow-hidden">
                    <h3 class="font-semibold flex-shrink-0">General Tags (#)</h3>
                    <p class="text-xs text-[--text-muted-dark] flex-shrink-0">Deleting a tag here will remove it from all prompts.</p>
                    <div id="general-tags-manager-container" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                </div>
                <!-- Coluna Target LLM -->
                <div class="flex flex-col gap-3 p-3 bg-[#121212] rounded-md overflow-hidden">
                    <div class="flex-shrink-0">
                        <h3 class="font-semibold">Target LLM</h3>
                        <div class="flex gap-2 mt-3">
                            <input id="add-llm-category-manager-input" type="text" placeholder="New Category..." class="form-control w-full rounded-md py-1 px-2 text-sm">
                            <button id="add-llm-category-manager-btn" class="action-button primary px-3">+</button>
                        </div>
                    </div>
                    <div id="llm-manager-container" class="flex-grow overflow-y-auto space-y-2 pr-2 mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Input Gallery -->
    <div id="input-gallery-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-6xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Input Gallery</h2>
                <div class="flex items-center gap-4">
                    <button id="save-input-gallery-btn" class="action-button primary">Save Input</button>
                    <button id="close-input-gallery-btn" class="p-2 rounded-full hover:bg-[#333]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow flex overflow-hidden">
                <aside id="input-gallery-list-container" class="w-1/3 p-4 border-r border-[--border-dark] flex flex-col">
                    <button id="add-new-input-btn" class="action-button w-full mb-4">New Input</button>
                    <div id="input-gallery-list" class="flex-grow overflow-y-auto pr-2 space-y-2">
                        <!-- Lista de inputs será inserida aqui -->
                    </div>
                </aside>
                <main class="w-2/3 p-4 flex flex-col">
                    <input type="hidden" id="input-gallery-id">
                    <input id="input-gallery-name" placeholder="Input name..." class="form-input font-sans w-full p-2 text-lg font-medium mb-4 bg-[#222222] rounded-md">
                    <textarea id="input-gallery-editor" placeholder="Input content..." class="form-input font-mono w-full h-full p-4 text-base leading-relaxed resize-none bg-[#222222] rounded-md flex-grow"></textarea>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal Node Flow -->
    <div id="node-flow-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-8">
        <div class="bg-[--card-bg-dark] w-full max-w-7xl h-full max-h-[90vh] rounded-lg shadow-xl border border-[--border-dark] flex flex-col">
            <div class="p-4 border-b border-[--border-dark] flex justify-between items-center flex-shrink-0">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold">Node Flow</h2>
                    <select id="saved-flows-dropdown" class="form-control rounded-md py-1.5 px-3 text-sm focus:ring-2">
                         <option value="">Load a saved flow...</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <button id="save-flow-btn" class="action-button primary">Save Flow</button>
                    <button id="close-node-flow-btn" class="p-2 rounded-full hover:bg-[#333]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow flex overflow-hidden">
                <aside id="node-flow-sidebar" class="w-1/4 p-4 border-r border-[--border-dark] flex flex-col">
                     <div class="mb-3 flex-shrink-0">
                        <label for="node-flow-project-filter" class="text-xs font-medium text-[--text-muted-dark]">Filter by Project:</label>
                        <select id="node-flow-project-filter" class="form-control w-full mt-1 rounded-md py-1.5 px-3 text-sm focus:ring-2">
                             <!-- Opções populadas via JS -->
                        </select>
                     </div>
                    <div id="node-flow-prompt-list" class="flex-grow overflow-y-auto pr-2 space-y-1">
                        <!-- Lista de prompts arrastáveis será inserida aqui -->
                    </div>
                </aside>
                <main id="node-flow-canvas" class="w-3/4 flex-grow relative">
                    <div id="node-flow-content">
                        <!-- Nós do fluxo serão inseridos aqui -->
                    </div>
                    <svg id="node-flow-connections" class="w-full h-full absolute top-0 left-0 pointer-events-none">
                        <g id="connections-group"></g>
                    </svg>
                </main>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
                    // --- CONFIGURAÇÃO DO SUPABASE ---
            const SUPABASE_URL = 'https://bjegpjohwquugyvfkict.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZWdwam9od3F1dWd5dmZraWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDkzMzksImV4cCI6MjA3MDQyNTMzOX0.0finKmSTim82UkBYY4Chnpa8O_WsKLCqIGrd892IFcY';
            const { createClient } = supabase;
            const supabaseClient = createClient(
                'https://bjegpjohwquugyvfkict.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZWdwam9od3F1dWd5dmZraWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDkzMzksImV4cCI6MjA3MDQyNTMzOX0.0finKmSTim82UkBYY4Chnpa8O_WsKLCqIGrd892IFcY'
            );

            const PROMPTS_STORAGE_KEY = 'promptManagerApp_prompts';
            const XML_TAGS_STORAGE_KEY = 'promptManagerApp_xmlTags';
            const TEMPLATES_STORAGE_KEY = 'promptManagerApp_templates';
            const VAR_LIBRARY_STORAGE_KEY = 'promptManagerApp_varLibrary';
            const LLM_LIST_STORAGE_KEY = 'promptManagerApp_llmList';
            const INPUT_GALLERY_STORAGE_KEY = 'promptManagerApp_inputGallery';
            const NODE_FLOWS_STORAGE_KEY = 'promptManagerApp_nodeFlows';
            
            // --- ESTADO DA APLICAÇÃO ---
            let prompts = [];
            let xmlTags = [];
            let templates = [];
            let varLibrary = [];
            let llmList = {};
            let inputGallery = [];
            let savedFlows = [];
            let selectedVersionId = null;
            let selectedInputId = null; // Para o modal Input Gallery
            let expandedPromptGroups = new Set();
            let itemToDelete = { type: null, id: null };
            let activeStatusFilter = 'all';
            const effortLevels = ['Low', 'Medium', 'High'];
            let versionsToCompare = new Set();
            let activeComparisonPromptId = null;
            let findState = {
                matches: [],
                currentIndex: -1,
                query: ''
            };
            let snippets = []; // Para a função de copiar snippet
            // Estado do Gráfico
            let isCreatingConnection = false;
            let firstNodeForConnection = null;
            let selectedLinkForDeletion = null;
            // Estado do Node Flow
            let flowNodes = [];
            let flowConnections = [];
            let isDraggingNode = false;
            let isDrawingConnection = false;
            let connectionStartNodeId = null;
            let tempLine = null;
            let currentTransform = d3.zoomIdentity;


            // --- ELEMENTOS DO DOM ---
            const mainHeader = document.getElementById('main-header');
            const mainContent = document.getElementById('main-content');
            const mainEditor = document.getElementById('main-editor');
            const snippetButtonsOverlay = document.getElementById('snippet-buttons-overlay');
            const titleInput = document.getElementById('prompt-title-input');
            const projectInput = document.getElementById('project-name-input-aside');
            const versionsHistoryList = document.getElementById('versions-history-list');
            const statusContainer = document.getElementById('status-selector-container');
            const searchInput = document.getElementById('search-versions-input');
            const editorStats = document.getElementById('editor-stats');
            const copyPromptBtn = document.getElementById('copy-prompt-btn');
            const llmSelect = document.getElementById('llm-select');
            const statusFilterContainer = document.getElementById('status-filter-container');
            const variablesSection = document.getElementById('variables-section');
            const variablesContainer = document.getElementById('variables-container');
            const dependencySelect = document.getElementById('dependency-select');
            const xmlTagInput = document.getElementById('xml-tag-input');
            const addXmlTagBtn = document.getElementById('add-xml-tag-btn');
            const xmlTagDropdown = document.getElementById('xml-tag-dropdown');
            const dependencyBar = document.getElementById('dependency-bar');
            const dependencyTagContainer = document.getElementById('dependency-tag-container');
            const compareVersionsBtn = document.getElementById('compare-versions-btn');
            const toggleCommentsBtn = document.getElementById('toggle-comments-btn');
            const commentsSection = document.getElementById('comments-section');
            const commentsTextarea = document.getElementById('comments-textarea');
            const navigationMap = document.getElementById('navigation-map');
            
            const addPromptBtn = document.getElementById('add-prompt-btn');
            const addMajorVersionBtn = document.getElementById('add-major-version-btn');
            const addMinorVersionBtn = document.getElementById('add-minor-version-btn');
            const saveAsTemplateBtn = document.getElementById('save-as-template-btn');
            const forkVersionBtn = document.getElementById('fork-version-btn');
            const deleteVersionBtn = document.getElementById('delete-version-btn');
            const downloadJsonBtn = document.getElementById('download-json-btn');
            const downloadMdBtn = document.getElementById('download-md-btn');

            // Modais
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmModalInputContainer = document.getElementById('confirm-modal-input-container');
            const confirmModalInput = document.getElementById('confirm-modal-input');
            const confirmModalButtons = document.getElementById('confirm-modal-buttons');
            
            const galleryModal = document.getElementById('gallery-modal');
            const galleryBtn = document.getElementById('gallery-btn');
            const closeGalleryBtn = document.getElementById('close-gallery-btn');
            const galleryGrid = document.getElementById('gallery-grid');
            
            const projectsModal = document.getElementById('projects-modal');
            const projectsBtn = document.getElementById('projects-btn');
            const closeProjectsBtn = document.getElementById('close-projects-btn');
            const addProjectBtn = document.getElementById('add-project-btn');
            addProjectBtn.addEventListener('click', () => {
                const addProjectPopup = document.getElementById('add-project-popup');
                const newProjectNameInput = document.getElementById('new-project-name-input');
                const cancelAddProjectBtn = document.getElementById('cancel-add-project-btn');
                const confirmAddProjectBtn = document.getElementById('confirm-add-project-btn');

                // Exibir o popup
                addProjectPopup.classList.remove('hidden');
                newProjectNameInput.value = '';
                newProjectNameInput.focus();

                // Cancelar adição
                cancelAddProjectBtn.addEventListener('click', () => {
                    addProjectPopup.classList.add('hidden');
                });

                // Confirmar adição
                confirmAddProjectBtn.addEventListener('click', async() => {
                    const newProjectName = newProjectNameInput.value.trim();
                    if (newProjectName) {
                        const datalist = document.getElementById('project-list-aside');
                        const exists = [...datalist.options].some(option => option.value === newProjectName);
                        if (!exists) {
                            const option = document.createElement('option');
                            option.value = newProjectName;
                            datalist.appendChild(option);

                            // Exibir modal estilizado
                            showModal(
                                'Success',
                                `Project "${newProjectName}" added successfully.`,
                                [{ text: 'OK', className: 'action-button primary', onClick: hideModal }]
                            );
                        } else {
                            showModal(
                                'Error',
                                'This project already exists.',
                                [{ text: 'OK', className: 'action-button primary', onClick: hideModal }]
                            );
                        }
                    }
                    addProjectPopup.classList.add('hidden');
                });
            });
            const projectsListContainer = document.getElementById('projects-list-container');

            const templatesModal = document.getElementById('templates-modal');
            const templatesBtn = document.getElementById('templates-btn');
            const closeTemplatesBtn = document.getElementById('close-templates-btn');
            const templatesGridContainer = document.getElementById('templates-grid-container');
            
            const dependencyViewerModal = document.getElementById('dependency-viewer-modal');
            const dependencyViewerTitle = document.getElementById('dependency-viewer-title');
            const dependencyViewerContent = document.getElementById('dependency-viewer-content');
            const closeDependencyViewerBtn = document.getElementById('close-dependency-viewer-btn');
            
            const commentsViewerModal = document.getElementById('comments-viewer-modal');
            const commentsViewerTitle = document.getElementById('comments-viewer-title');
            const commentsViewerContent = document.getElementById('comments-viewer-content');
            const closeCommentsViewerBtn = document.getElementById('close-comments-viewer-btn');

            const readModeBtn = document.getElementById('read-mode-btn');
            const readModeIconClosed = document.getElementById('read-mode-icon-closed');
            const readModeIconOpen = document.getElementById('read-mode-icon-open');
            const readModeModal = document.getElementById('read-mode-modal');
            const readModeContent = document.getElementById('read-mode-content');

            const diffModal = document.getElementById('diff-modal');
            const diffModalTitle = document.getElementById('diff-modal-title');
            const closeDiffModalBtn = document.getElementById('close-diff-modal-btn');
            const diffPanelA = document.getElementById('diff-panel-a');
            const diffPanelB = document.getElementById('diff-panel-b');
            const diffTitleA = document.getElementById('diff-title-a');
            const diffTitleB = document.getElementById('diff-title-b');

            // Modal Gráfico
            const graphViewBtn = document.getElementById('graph-view-btn');
            const dependencyGraphModal = document.getElementById('dependency-graph-modal');
            const closeDependencyGraphBtn = document.getElementById('close-dependency-graph-btn');
            const dependencyGraphSvg = document.getElementById('dependency-graph-svg');
            const graphProjectFilter = document.getElementById('graph-project-filter');
            const createConnectionBtn = document.getElementById('create-connection-btn');
            const deleteConnectionBtn = document.getElementById('delete-connection-btn');
            const graphTooltip = document.getElementById('graph-tooltip');
            
            // Modal Gerenciador de Listas
            const listManagerBtn = document.getElementById('list-manager-btn');
            const listManagerModal = document.getElementById('list-manager-modal');
            const closeListManagerBtn = document.getElementById('close-list-manager-btn');
            const xmlTagsManagerContainer = document.getElementById('xml-tags-manager-container');
            const varLibraryManagerContainer = document.getElementById('var-library-manager-container');
            const generalTagsManagerContainer = document.getElementById('general-tags-manager-container');
            const addXmlTagManagerInput = document.getElementById('add-xml-tag-manager-input');
            const addXmlTagManagerBtn = document.getElementById('add-xml-tag-manager-btn');
            const addVarLibraryManagerInput = document.getElementById('add-var-library-manager-input');
            const addVarLibraryManagerBtn = document.getElementById('add-var-library-manager-btn');
            const llmManagerContainer = document.getElementById('llm-manager-container');
            const addLlmCategoryManagerInput = document.getElementById('add-llm-category-manager-input');
            const addLlmCategoryManagerBtn = document.getElementById('add-llm-category-manager-btn');

            // Modal Input Gallery
            const inputGalleryBtn = document.getElementById('input-gallery-btn');
            const inputGalleryModal = document.getElementById('input-gallery-modal');
            const closeInputGalleryBtn = document.getElementById('close-input-gallery-btn');
            const inputGalleryList = document.getElementById('input-gallery-list');
            const inputGalleryEditor = document.getElementById('input-gallery-editor');
            const saveInputGalleryBtn = document.getElementById('save-input-gallery-btn');
            const inputGalleryName = document.getElementById('input-gallery-name');
            const inputGalleryId = document.getElementById('input-gallery-id');
            const addNewInputBtn = document.getElementById('add-new-input-btn');
            
            // Add Input Dropdown
            const addInputInput = document.getElementById('add-input-input');
            const addInputDropdown = document.getElementById('add-input-dropdown');

            // Find and Replace
            const findBtn = document.getElementById('find-btn');
            const findReplaceBar = document.getElementById('find-replace-bar');
            const findInput = document.getElementById('find-input');
            const replaceInput = document.getElementById('replace-input');
            const findCounter = document.getElementById('find-counter');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const replaceBtn = document.getElementById('replace-btn');
            const replaceAllBtn = document.getElementById('replace-all-btn');
            const closeFindBtn = document.getElementById('close-find-btn');

            // Sliders e seus displays de valor
            const temperatureSlider = document.getElementById('temperature-slider');
            const temperatureValue = document.getElementById('temperature-value');
            const topPSlider = document.getElementById('top-p-slider');
            const topPValue = document.getElementById('top-p-value');
            const effortSlider = document.getElementById('effort-slider');
            const effortValue = document.getElementById('effort-value');

            // Tags
            const tagsInput = document.getElementById('tags-input-aside');
            const tagsContainer = document.getElementById('tags-container-aside');
            const tagsDropdown = document.getElementById('tags-dropdown-aside');
            
            // Var Library
            const varLibraryInput = document.getElementById('var-library-input');
            const addVarLibraryBtn = document.getElementById('add-var-library-btn');
            const varLibraryDropdown = document.getElementById('var-library-dropdown');
            
            // Node Flow
            const nodeFlowBtn = document.getElementById('node-flow-btn');
            const nodeFlowModal = document.getElementById('node-flow-modal');
            const closeNodeFlowBtn = document.getElementById('close-node-flow-btn');
            const nodeFlowPromptList = document.getElementById('node-flow-prompt-list');
            const nodeFlowCanvas = document.getElementById('node-flow-canvas');
            const nodeFlowContent = document.getElementById('node-flow-content');
            const nodeFlowConnections = document.getElementById('node-flow-connections');
            const connectionsGroup = document.getElementById('connections-group');
            const nodeFlowProjectFilter = document.getElementById('node-flow-project-filter');
            const saveFlowBtn = document.getElementById('save-flow-btn');
            const savedFlowsDropdown = document.getElementById('saved-flows-dropdown');

            // --- FUNÇÕES DE DADOS (AGORA COM SUPABASE) ---
            const loadDataFromSupabase = async () => {
                try {
                    console.log("Fetching data from Supabase...");

                    const { data: promptsData, error: promptsError } = await supabaseClient.from('prompts').select('*');
                    if (promptsError) throw promptsError;
                    prompts = promptsData || [];

                    const { data: templatesData, error: templatesError } = await supabaseClient.from('templates').select('*');
                    if (templatesError) throw templatesError;
                    templates = templatesData || [];

                    const { data: inputGalleryData, error: inputGalleryError } = await supabaseClient.from('input_gallery').select('*');
                    if (inputGalleryError) throw inputGalleryError;
                    inputGallery = inputGalleryData || [];

                    const { data: nodeFlowsData, error: nodeFlowsError } = await supabaseClient.from('node_flows').select('*');
                    if (nodeFlowsError) throw nodeFlowsError;
                    savedFlows = nodeFlowsData || [];

                    const { data: listsData, error: listsError } = await supabaseClient.from('global_lists').select('*');
                    if (listsError) throw listsError;

                    xmlTags = listsData.find(l => l.name === 'xml_tags')?.data || [];
                    varLibrary = listsData.find(l => l.name === 'var_library')?.data || [];
                    llmList = listsData.find(l => l.name === 'llm_list')?.data || {};

                    console.log("Data fetched successfully!");

                } catch (error) {
                    console.error("Error loading data from Supabase:", error);
                    alert("Could not load data from the database. Please check the console for errors.");
                }
            };

                        // Funções para salvar/atualizar/deletar dados individuais
            const upsertItem = async (table, data) => {
                const { data: rows, error } = await supabaseClient
                    .from(table)
                    .upsert(data)
                    .select();
                if (error) {
                    console.error(`Error upserting to ${table}:`, error);
                    return null;
                }
                return rows || null;
            };

            const deleteItem = async (table, id) => {
                const { error } = await supabaseClient.from(table).delete().eq('id', id);
                if (error) console.error(`Error deleting from ${table}:`, error);
            };

            const deleteItemsByPromptId = async (promptId) => {
                const { error } = await supabaseClient.from('prompts').delete().eq('promptId', promptId);
                if (error) console.error(`Error deleting prompts by promptId:`, error);
            };

            const updateGlobalList = async (listName, data) => {
                const { error } = await supabaseClient.from('global_lists').update({ data }).eq('name', listName);
                if (error) console.error(`Error updating global list ${listName}:`, error);
            }

            const savePromptsToStorage = () => localStorage.setItem(PROMPTS_STORAGE_KEY, JSON.stringify(prompts));
            const saveXmlTagsToStorage = () => localStorage.setItem(XML_TAGS_STORAGE_KEY, JSON.stringify(xmlTags));
            const saveTemplatesToStorage = () => localStorage.setItem(TEMPLATES_STORAGE_KEY, JSON.stringify(templates));
            const saveVarLibraryToStorage = () => localStorage.setItem(VAR_LIBRARY_STORAGE_KEY, JSON.stringify(varLibrary));
            const saveLlmListToStorage = () => localStorage.setItem(LLM_LIST_STORAGE_KEY, JSON.stringify(llmList));
            const saveInputGalleryToStorage = () => localStorage.setItem(INPUT_GALLERY_STORAGE_KEY, JSON.stringify(inputGallery));
            const saveFlowsToStorage = () => localStorage.setItem(NODE_FLOWS_STORAGE_KEY, JSON.stringify(savedFlows));


            // --- FUNÇÕES DE LÓGICA ---
            const addCurrentXmlTag = () => {
                const tagName = xmlTagInput.value.trim();
                if (tagName && !xmlTags.includes(tagName)) {
                    xmlTags.push(tagName);
                    saveXmlTagsToStorage();
                    updateGlobalList('xml_tags', xmlTags);
                    xmlTagInput.value = '';
                }
            };

            const addCurrentVarToLibrary = () => {
                let varName = varLibraryInput.value.trim();
                if (varName) {
                    if (!varName.startsWith('{{') || !varName.endsWith('}}')) {
                        varName = `{{${varName.replace(/{{|}}/g, '')}}}`;
                    }
                    if (!varLibrary.includes(varName)) {
                        varLibrary.push(varName);
                        saveVarLibraryToStorage();
                        updateGlobalList('var_library', varLibrary)
                        varLibraryInput.value = '';
                    }
                }
            };

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            const populateLlmSelect = () => {
                const currentVal = llmSelect.value;
                llmSelect.innerHTML = '<option value="generic">Unspecified</option>';
                
                const sortedGroupNames = Object.keys(llmList).sort();

                sortedGroupNames.forEach(groupName => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groupName;
                    llmList[groupName].sort().forEach(llm => {
                        const option = document.createElement('option');
                        option.value = llm;
                        option.textContent = llm;
                        optgroup.appendChild(option);
                    });
                    llmSelect.appendChild(optgroup);
                });
                
                const allLlms = Object.values(llmList).flat();
                if (allLlms.includes(currentVal)) {
                    llmSelect.value = currentVal;
                } else {
                    llmSelect.value = 'generic';
                }
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            };

            const populateProjectList = (selectElement) => {
                const existingProjects = [...new Set(prompts.map(p => p.project).filter(Boolean))].sort();
                selectElement.innerHTML = '<option value="all">All Projects</option>';
                existingProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    selectElement.appendChild(option);
                });
            };
            
            const populateProjectDataList = () => {
                 const projectList = document.getElementById('project-list-aside');
                 const existingProjects = [...new Set(prompts.map(p => p.project).filter(Boolean))];
                 projectList.innerHTML = '';
                 existingProjects.forEach(project => {
                     const option = document.createElement('option');
                     option.value = project;
                     projectList.appendChild(option);
                 });
            };

            const populateDependencyList = () => {
                dependencySelect.innerHTML = '<option value="">No dependency</option>';
                const sortedPrompts = [...prompts].sort((a, b) => {
                    if (a.title < b.title) return -1;
                    if (a.title > b.title) return 1;
                    return parseFloat(b.version) - parseFloat(a.version);
                });

                sortedPrompts.forEach(p => {
                    if (p.id === selectedVersionId) return;
                    
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.title} (v${p.version})`;
                    dependencySelect.appendChild(option);
                });
            };
            
            const renderDependencyBar = (parentId) => {
                const parentPrompt = prompts.find(p => p.id === parentId);
                if (parentPrompt) {
                    dependencyTagContainer.innerHTML = `
                        <span class="text-sm text-[--text-muted-dark] mr-2">Dependence:</span>
                        <span class="dependency-tag text-sm font-mono" data-dependency-id="${parentPrompt.id}">
                            ${parentPrompt.title} (v${parentPrompt.version})
                        </span>
                    `;
                    dependencyBar.classList.remove('hidden');
                } else {
                    dependencyBar.classList.add('hidden');
                }
            };

            const renderVersionsList = () => {
                versionsHistoryList.innerHTML = '';
                const filterText = searchInput.value.toLowerCase().trim();
                
                const allGroupedPrompts = prompts.reduce((acc, p) => {
                    if (!acc[p.promptId]) {
                        acc[p.promptId] = { title: p.title, project: p.project, versions: [] };
                    }
                    acc[p.promptId].versions.push(p);
                    acc[p.promptId].title = p.title;
                    acc[p.promptId].project = p.project;
                    return acc;
                }, {});

                const filteredAndSortedGroups = Object.keys(allGroupedPrompts)
                    .map(promptId => {
                        const group = allGroupedPrompts[promptId];
                        // Filter versions within the group first
                        const matchingVersions = group.versions.filter(v => {
                            const matchesStatus = activeStatusFilter === 'all' || v.status === activeStatusFilter;
                            if (!matchesStatus) return false;

                            if (filterText === '') return true;

                            if (filterText.startsWith('#')) {
                                return v.tags && v.tags.some(tag => tag.toLowerCase().includes(filterText));
                            } else {
                                const matchesTitle = v.title.toLowerCase().includes(filterText);
                                const matchesProject = v.project && v.project.toLowerCase().includes(filterText);
                                const matchesTags = v.tags && v.tags.some(tag => tag.toLowerCase().includes(filterText));
                                return matchesTitle || matchesProject || matchesTags;
                            }
                        });

                        // If the group has matching versions, return it with only those versions
                        if (matchingVersions.length > 0) {
                            return {
                                promptId,
                                title: group.title,
                                project: group.project,
                                versions: matchingVersions.sort((a, b) => parseFloat(b.version) - parseFloat(a.version))
                            };
                        }
                        return null; // Otherwise, discard the group
                    })
                    .filter(Boolean); // Remove null groups


                if (filteredAndSortedGroups.length === 0) {
                    versionsHistoryList.innerHTML = `<p class="text-sm text-[--text-muted-dark] p-2">No results found.</p>`;
                    return;
                }

                filteredAndSortedGroups.forEach(group => {
                    const isExpanded = expandedPromptGroups.has(group.promptId);
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'prompt-group group';
                    const header = document.createElement('div');
                    header.className = `prompt-group-header ${isExpanded ? 'expanded' : ''}`;
                    header.dataset.promptId = group.promptId;
                    header.innerHTML = `
                        <div class="flex items-center flex-grow truncate">
                            <svg class="toggle-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            <div class="flex flex-col">
                                <span class="truncate font-sans font-medium text-sm">${group.title}</span>
                                <span class="truncate font-sans text-xs text-[--text-muted-dark]">${group.project || 'No project'}</span>
                            </div>
                        </div>
                        <button data-action="delete-group" data-prompt-id="${group.promptId}" class="delete-group-btn invisible group-hover:visible p-1 rounded-md hover:bg-red-900/50 text-[--text-muted-dark] hover:text-red-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    const subList = document.createElement('div');
                    subList.className = `version-sub-list ${isExpanded ? 'expanded' : ''}`;
                    group.versions.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'version-item font-mono';
                        item.innerHTML = `
                            <div class="flex items-center flex-grow" data-action="select" data-id="${p.id}">
                                <input type="checkbox" class="mr-3 h-4 w-4 rounded bg-gray-700 border-gray-600 text-fuchsia-600 focus:ring-fuchsia-500" data-id="${p.id}" data-prompt-id="${p.promptId}">
                                <span class="truncate pr-2 text-gray-400">Version</span>
                                <span class="font-medium text-white">${p.version}</span>
                            </div>
                            <span class="text-xs text-gray-500" data-action="select" data-id="${p.id}">${formatDate(p.date)}</span>
                        `;
                        if (p.id === selectedVersionId) item.classList.add('selected');
                        subList.appendChild(item);
                    });
                    groupContainer.appendChild(header);
                    groupContainer.appendChild(subList);
                    versionsHistoryList.appendChild(groupContainer);
                });
            };

            const renderGallery = () => {
                galleryGrid.innerHTML = ''; // Limpa o conteúdo anterior

                const groupedPrompts = prompts.reduce((acc, p) => {
                    if (!acc[p.promptId]) {
                        acc[p.promptId] = [];
                    }
                    acc[p.promptId].push(p);
                    return acc;
                }, {});

                const latestVersions = Object.values(groupedPrompts).map(versions => {
                    return versions.sort((a, b) => {
                        const [majorA, minorA = 0] = a.version.split('.').map(Number);
                        const [majorB, minorB = 0] = b.version.split('.').map(Number);
                        if (majorA !== majorB) return majorB - majorA;
                        return minorB - minorA;
                    })[0];
                });

                latestVersions.forEach(prompt => {
                    const versionCount = groupedPrompts[prompt.promptId].length;
                    let dependencyTitle = 'N/A';
                    if (prompt.parentId) {
                        const parentPrompt = prompts.find(p => p.id === prompt.parentId);
                        if (parentPrompt) {
                            dependencyTitle = `${parentPrompt.title} (v${parentPrompt.version})`;
                        }
                    }

                    const card = document.createElement('div');
                    card.className = 'gallery-card bg-[--card-bg-dark] border border-[--border-dark] rounded-lg p-3 flex flex-col text-xs text-[--text-dark]';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-base mb-2 truncate pr-2" style="color: var(--accent-fuchsia);">${prompt.title}</h3>
                            <span class="text-xs font-mono bg-[#333] text-[#ccc] rounded-full px-2 py-0.5">${versionCount} ${versionCount > 1 ? 'versions' : 'version'}</span>
                        </div>
                        <div class="space-y-1 flex-grow">
                            <p><strong class="text-[--text-muted-dark] font-normal">Project:</strong> ${prompt.project || 'N/A'}</p>
                            <p><strong class="text-[--text-muted-dark] font-normal">LLM:</strong> ${prompt.llm || 'N/A'}</p>
                            <p class="truncate"><strong class="text-[--text-muted-dark] font-normal">Dependence:</strong> ${dependencyTitle}</p>
                        </div>
                        <div class="mt-3 pt-2 border-t border-[--border-dark] grid grid-cols-3 gap-2 text-center font-mono">
                            <div>
                                <p class="text-[--text-muted-dark] text-xs">Temp</p>
                                <p class="font-semibold text-sm">${prompt.temperature}</p>
                            </div>
                            <div>
                                <p class="text-[--text-muted-dark] text-xs">Top P</p>
                                <p class="font-semibold text-sm">${prompt.topP}</p>
                            </div>
                            <div>
                                <p class="text-[--text-muted-dark] text-xs">Effort</p>
                                <p class="font-semibold text-sm">${prompt.effort}</p>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        loadVersionIntoEditor(prompt.id);
                        galleryModal.classList.add('hidden');
                    });
                    galleryGrid.appendChild(card);
                });
            };

            const renderProjectsView = () => {
                projectsListContainer.innerHTML = '';
                const groupedByProject = prompts.reduce((acc, p) => {
                    const project = p.project || 'No Project';
                    if (!acc[project]) {
                        acc[project] = [];
                    }
                    acc[project].push(p);
                    return acc;
                }, {});

                Object.keys(groupedByProject).sort().forEach(project => {
                    const projectWrapper = document.createElement('div');
                    projectWrapper.className = 'mb-6';
                    
                    const projectTitle = document.createElement('h3');
                    projectTitle.className = 'text-lg font-bold text-[--accent-fuchsia] border-b border-[--border-dark] pb-2 mb-3';
                    projectTitle.textContent = project;
                    projectWrapper.appendChild(projectTitle);

                    const table = document.createElement('table');
                    table.className = 'w-full text-left text-xs table-fixed';
                    table.innerHTML = `
                        <thead>
                            <tr class="border-b border-[--border-dark]">
                                <th class="py-2 px-2 font-semibold w-[25%]">Prompt</th>
                                <th class="py-2 px-2 font-semibold text-center w-[8%]">Version</th>
                                <th class="py-2 px-2 font-semibold w-[22%]">Dependence</th>
                                <th class="py-2 px-2 font-semibold w-[15%]">Target</th>
                                <th class="py-2 px-2 font-semibold text-center w-[7%]">Temp</th>
                                <th class="py-2 px-2 font-semibold text-center w-[7%]">Top P</th>
                                <th class="py-2 px-2 font-semibold w-[10%]">Effort</th>
                                <th class="py-2 px-2 font-semibold text-center w-[6%]">Notes</th>
                            </tr>
                        </thead>
                    `;
                    const tbody = document.createElement('tbody');
                    
                    groupedByProject[project].sort((a,b) => a.title.localeCompare(b.title) || parseFloat(b.version) - parseFloat(a.version)).forEach(prompt => {
                        let dependencyTitle = 'N/A';
                        if (prompt.parentId) {
                            const parentPrompt = prompts.find(p => p.id === prompt.parentId);
                            if (parentPrompt) {
                                dependencyTitle = `${parentPrompt.title} (v${parentPrompt.version})`;
                            }
                        }

                        const row = document.createElement('tr');
                        row.className = 'hover:bg-[#333] cursor-pointer border-b border-[--border-dark]';
                        row.dataset.id = prompt.id;
                        row.innerHTML = `
                            <td class="py-2 px-2 truncate">${prompt.title}</td>
                            <td class="py-2 px-2 text-center">${prompt.version}</td>
                            <td class="py-2 px-2 truncate">${dependencyTitle}</td>
                            <td class="py-2 px-2 truncate">${prompt.llm}</td>
                            <td class="py-2 px-2 text-center">${prompt.temperature}</td>
                            <td class="py-2 px-2 text-center">${prompt.topP}</td>
                            <td class="py-2 px-2">${prompt.effort}</td>
                        `;
                        
                        const commentsCell = document.createElement('td');
                        commentsCell.className = 'py-2 px-2 text-center';
                        if (prompt.comments && prompt.comments.trim() !== '') {
                            commentsCell.innerHTML = `
                                <button data-action="view-comments" data-id="${prompt.id}" class="p-1 rounded-md text-[--text-muted-dark] hover:text-white hover:bg-[#333]">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                                    </svg>
                                </button>
                            `;
                        }
                        row.appendChild(commentsCell);
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    projectWrapper.appendChild(table);
                    projectsListContainer.appendChild(projectWrapper);
                });
            };

            const renderTemplatesGrid = () => {
                templatesGridContainer.innerHTML = '';
                if (templates.length === 0) {
                    templatesGridContainer.innerHTML = `<p class="text-sm text-[--text-muted-dark] col-span-full">No templates saved.</p>`;
                    return;
                }

                templates.forEach(template => {
                    let dependencyTitle = 'N/A';
                    if (template.parentId) {
                        const parentPrompt = prompts.find(p => p.id === template.parentId);
                        if (parentPrompt) {
                            dependencyTitle = `${parentPrompt.title} (v${parentPrompt.version})`;
                        }
                    }

                    const card = document.createElement('div');
                    card.className = 'gallery-card bg-[--card-bg-dark] border border-[--border-dark] rounded-lg p-3 flex flex-col text-xs text-[--text-dark]';
                    card.dataset.id = template.id;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-base truncate pr-2" style="color: var(--accent-fuchsia);">${template.name}</h3>
                            <span class="text-xs font-mono bg-[#333] text-[#ccc] rounded-full px-2 py-0.5">Template</span>
                        </div>
                        <div class="space-y-1 flex-grow mb-3">
                            <p class="truncate"><strong class="text-[--text-muted-dark] font-normal">Based on:</strong> ${template.title || 'N/A'}</p>
                            <p><strong class="text-[--text-muted-dark] font-normal">Project:</strong> ${template.project || 'N/A'}</p>
                            <p><strong class="text-[--text-muted-dark] font-normal">LLM:</strong> ${template.llm || 'N/A'}</p>
                            <p class="truncate"><strong class="text-[--text-muted-dark] font-normal">Dependence:</strong> ${dependencyTitle}</p>
                        </div>
                        <div class="mt-auto pt-2 border-t border-[--border-dark] grid grid-cols-3 gap-2 text-center font-mono">
                            <div>
                                <p class="text-[--text-muted-dark] text-xs">Temp</p>
                                <p class="font-semibold text-sm">${template.temperature}</p>
                            </div>
                            <div>
                                <p class="text-[--text-muted-dark] text-xs">Top P</p>
                                <p class="font-semibold text-sm">${template.topP}</p>
                            </div>
                             <div>
                                <p class="text-[--text-muted-dark] text-xs">Effort</p>
                                <p class="font-semibold text-sm">${template.effort}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-[--border-dark] flex gap-2">
                            <button data-action="load-template" class="action-button primary flex-grow text-center">Use</button>
                            <button data-action="delete-template" class="action-button text-red-500 hover:bg-red-900/20 hover:border-red-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    templatesGridContainer.appendChild(card);
                });
            };
            
            const updateStatusSelectorUI = (status) => {
                document.querySelectorAll('.status-option').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.status === status) btn.classList.add('active');
                });
            };

            const updateStatusFilterUI = () => {
                document.querySelectorAll('#status-filter-container .filter-tag-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === activeStatusFilter) btn.classList.add('active');
                });
            };

            const updateEditorStats = () => {
                const content = mainEditor.value;
                const charCount = content.length;
                const wordCount = content.trim().split(/\s+/).filter(Boolean).length;
                const tokenCount = Math.ceil(charCount / 4);
                editorStats.textContent = `${tokenCount} tokens / ${wordCount} words / ${charCount} characters`;
            };

            const renderVariables = () => {
                const content = mainEditor.value;
                const variableRegex = /\{\{([a-zA-Z0-9_]+)\}\}/g;
                let match;
                const variables = new Set();
                while ((match = variableRegex.exec(content)) !== null) {
                    variables.add(match[1]);
                }

                if (variables.size === 0) {
                    variablesSection.classList.add('hidden');
                    return;
                }

                variablesSection.classList.remove('hidden');
                variablesContainer.innerHTML = '';
                variables.forEach(varName => {
                    const varInputHTML = `
                        <div class="flex items-center gap-2">
                            <label for="var-${varName}" class="w-1/3 text-sm text-[--text-muted-dark] font-mono">${varName}:</label>
                            <input type="text" id="var-${varName}" name="${varName}" class="w-2/3 form-control rounded-md py-1 px-2 text-sm focus:ring-2 focus:ring-fuchsia-500 focus:border-fuchsia-500">
                        </div>
                    `;
                    variablesContainer.innerHTML += varInputHTML;
                });
            };
            
            const updateSlidersUI = (params = {}) => {
                temperatureSlider.value = params.temperature ?? 0.7;
                temperatureValue.textContent = parseFloat(temperatureSlider.value).toFixed(1);
                
                topPSlider.value = params.topP ?? 0.9;
                topPValue.textContent = parseFloat(topPSlider.value).toFixed(2);
                
                const effortIndex = effortLevels.indexOf(params.effort) !== -1 ? effortLevels.indexOf(params.effort) : 1; // Default to Medium
                effortSlider.value = effortIndex;
                effortValue.textContent = effortLevels[effortIndex];
            };

            // --- FUNÇÕES DE LÓGICA ---
            const showModal = (title, text, buttons, options = {}) => {
                confirmModalTitle.textContent = title;
                confirmModalText.innerHTML = text;
                confirmModalButtons.innerHTML = '';
                buttons.forEach(btn => {
                    const buttonEl = document.createElement('button');
                    buttonEl.className = btn.className;
                    buttonEl.textContent = btn.text;
                    buttonEl.onclick = btn.onClick;
                    confirmModalButtons.appendChild(buttonEl);
                });
            
                if (options.showInput) {
                    confirmModalInput.value = options.inputValue || '';
                    confirmModalInput.placeholder = options.inputPlaceholder || '';
                    confirmModalInputContainer.classList.remove('hidden');
                } else {
                    confirmModalInputContainer.classList.add('hidden');
                }
            
                confirmModal.classList.remove('hidden');
            };
            
            const hideModal = () => {
                confirmModal.classList.add('hidden');
            };
            
            const showValidationAlert = (message) => {
                showModal('Required Field', message, [
                    { text: 'OK', className: 'action-button primary', onClick: hideModal }
                ]);
            };
            
            const showDeleteModal = (type, id) => {
                itemToDelete = { type, id };
                const title = 'Confirm Deletion';
                const text = type === 'group' 
                    ? 'Are you sure you want to delete this prompt and all its versions? This action cannot be undone.'
                    : 'Are you sure you want to delete this specific version?';
            
                showModal(title, text, [
                    { text: 'Cancel', className: 'action-button', onClick: hideModal },
                    { text: 'Delete', className: 'action-button bg-[--accent-red] text-white border-[--accent-red-hover] hover:bg-[--accent-red-hover]', onClick: executeDelete }
                ]);
            };
            
            const showDependencyViewer = (dependencyId) => {
                const prompt = prompts.find(p => p.id === dependencyId);
                if (prompt) {
                    dependencyViewerTitle.textContent = `${prompt.title} (v${prompt.version})`;
                    dependencyViewerContent.textContent = prompt.content;
                    dependencyViewerModal.classList.remove('hidden');
                }
            };
            
            const showCommentsViewer = (promptId) => {
                const prompt = prompts.find(p => p.id === promptId);
                if (prompt && prompt.comments) {
                    commentsViewerTitle.textContent = `Comments - ${prompt.title} (v${prompt.version})`;
                    commentsViewerContent.textContent = prompt.comments;
                    commentsViewerModal.classList.remove('hidden');
                }
            };
            
            const executeDelete = async () => {
                if (!itemToDelete.id) return;

                if (itemToDelete.type === 'group') {
                    await deleteItemsByPromptId(itemToDelete.id);
                    prompts = prompts.filter(p => p.promptId !== itemToDelete.id);
                    if (selectedVersionId && !prompts.some(p => p.id === selectedVersionId)) {
                        clearEditorForNewPrompt();
                    }
                } else if (itemToDelete.type === 'version') {
                    await deleteItem('prompts', itemToDelete.id);
                    prompts = prompts.filter(p => p.id !== itemToDelete.id);
                    if (selectedVersionId === itemToDelete.id) {
                        clearEditorForNewPrompt();
                    }
                }
                hideModal();
                renderVersionsList();
            };
            
            const clearEditorForNewPrompt = () => {
                titleInput.value = '';
                projectInput.value = '';
                mainEditor.value = '';
                commentsTextarea.value = '';
                commentsSection.classList.add('hidden');
                selectedVersionId = null;
                llmSelect.value = 'generic';
                dependencySelect.value = '';
                updateStatusSelectorUI('write');
                updateEditorStats();
                renderVariables();
                updateSlidersUI(); // Reset sliders to default
                dependencyBar.classList.add('hidden');
                titleInput.focus();
                populateProjectDataList();
                populateDependencyList();
                renderVersionsList(); 
                renderPromptTags([]);
                tagsInput.value = '';
                renderNavigationMap();
                updateSnippetButtons();
            };
            
            const loadVersionIntoEditor = (versionId) => {
                const promptVersion = prompts.find(p => p.id === versionId);
                if (!promptVersion) return;
                titleInput.value = promptVersion.title;
                projectInput.value = promptVersion.project;
                mainEditor.value = promptVersion.content;
                commentsTextarea.value = promptVersion.comments || '';
                llmSelect.value = promptVersion.llm || 'generic';
                selectedVersionId = versionId;
                updateStatusSelectorUI(promptVersion.status);
                updateEditorStats();
                renderVariables();
                updateSlidersUI(promptVersion);
                expandedPromptGroups.add(String(promptVersion.promptId));
            
                if (promptVersion.parentId) {
                    renderDependencyBar(promptVersion.parentId);
                } else {
                    dependencyBar.classList.add('hidden');
                }
            
                populateProjectDataList();
                populateDependencyList();
                dependencySelect.value = promptVersion.parentId || '';
                renderVersionsList(); 
                renderPromptTags(promptVersion.tags);
                tagsInput.value = '';
                renderNavigationMap();
                updateSnippetButtons();
            };
            
            const saveVersion = async (isMajor = false) => {
                const title = titleInput.value.trim();
                const project = projectInput.value.trim();
                const content = mainEditor.value.trim();
                const comments = commentsTextarea.value.trim();
                const activeStatus = document.querySelector('.status-option.active')?.dataset.status || 'write';
                const llm = llmSelect.value;
                const parentId = dependencySelect.value ? parseInt(dependencySelect.value, 10) : null;
                const temperature = parseFloat(temperatureSlider.value);
                const topP = parseFloat(topPSlider.value);
                const effort = effortLevels[effortSlider.value];

                if (!project || !title || !content || llm === 'generic') {
                    showValidationAlert('Project, Title, Content, and Target LLM are required fields.');
                    return;
                }

                const currentTags = [...tagsContainer.querySelectorAll('.prompt-tag span')].map(span => span.textContent);

                let newVersionNumber;
                let promptIdToUse;

                if (selectedVersionId === null) {
                    // CASO 1: Nenhum prompt selecionado (clicou em "Add Prompt").
                    // Sempre cria um novo prompt pai, versão 1.0.
                    promptIdToUse = crypto.randomUUID();
                    newVersionNumber = '1.0';
                } else {
                    // CASO 2: Um prompt existente está selecionado.
                    const currentPrompt = prompts.find(p => p.id === selectedVersionId);
                    promptIdToUse = currentPrompt.promptId;
                    const versionsOfSamePrompt = prompts.filter(p => p.promptId === promptIdToUse);
                    
                    const latestVersion = versionsOfSamePrompt.sort((a, b) => {
                        const [majorA, minorA = 0] = a.version.split('.').map(Number);
                        const [majorB, minorB = 0] = b.version.split('.').map(Number);
                        if (majorA !== majorB) return majorB - majorA;
                        return minorB - minorA;
                    })[0];
                    
                    const [major, minor = 0] = latestVersion.version.split('.').map(Number);

                    if (isMajor) {
                        // Se for "Save Major", incrementa o número principal e zera o secundário.
                        newVersionNumber = `${major + 1}.0`;
                    } else {
                        // Se for "Save New" (minor), incrementa o número secundário.
                        newVersionNumber = `${major}.${(minor || 0) + 1}`;
                    }
                }

                const newVersion = {
                    promptId: promptIdToUse, // <-- propriedade atualizada
                    title, project, content,
                    version: newVersionNumber, status: activeStatus, llm, date: new Date().toISOString(), parentId,
                    temperature, topP, effort, tags: currentTags, comments
                };

                const rows = await upsertItem('prompts', newVersion);
                const saved = rows && rows[0] ? rows[0] : newVersion;
                prompts.push(saved);
                loadVersionIntoEditor(saved.id);
            };
            
            const forkVersion = async () => {
                if (!selectedVersionId) {
                    showValidationAlert('Please select a version to fork.');
                    return;
                }
            
                const originalPrompt = prompts.find(p => p.id === selectedVersionId);
                if (!originalPrompt) return;
            
                const newFork = {
                    promptId: Date.now(), // Cria um novo grupo (ID de prompt)
                    title: `(Fork) ${originalPrompt.title}`,
                    project: originalPrompt.project,
                    content: originalPrompt.content,
                    version: '1.0',
                    status: 'write',
                    llm: originalPrompt.llm,
                    date: new Date().toISOString(),
                    parentId: selectedVersionId, // Mantém o link com a versão original
                    temperature: originalPrompt.temperature,
                    topP: originalPrompt.topP,
                    effort: originalPrompt.effort,
                    tags: [...originalPrompt.tags], // Cria uma cópia das tags
                    comments: `Fork of version ${originalPrompt.version}. Original comment: ${originalPrompt.comments || 'None.'}`
                };
            
                const rows = await upsertItem('prompts', newFork);
                const saved = rows && rows[0] ? rows[0] : newFork;
                prompts.push(saved);
                savePromptsToStorage();
                loadVersionIntoEditor(saved.id);
            };
            
            const downloadFile = (format) => {
                if (!selectedVersionId) {
                    showValidationAlert('Please select a version to download.');
                    return;
                }
                const version = prompts.find(p => p.id === selectedVersionId);
                let content, filename, mimeType;
                if (format === 'json') {
                    content = JSON.stringify(version, null, 2);
                    filename = `${version.title.replace(/ /g, '_')}_v${version.version}.json`;
                    mimeType = 'application/json';
                } else {
                    content = `# ${version.title} (v${version.version})\n\n**Project:** ${version.project}\n**Status:** ${version.status}\n**LLM:** ${version.llm}\n**Tags:** ${version.tags.join(', ')}\n**Temperature:** ${version.temperature}\n**Top P:** ${version.topP}\n**Effort:** ${version.effort}\n\n---\n\n${version.content}`;
                    filename = `${version.title.replace(/ /g, '_')}_v${version.version}.md`;
                    mimeType = 'text/markdown';
                }
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([content], { type: mimeType }));
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            };

            const toggleReadMode = () => {
                const isHidden = readModeModal.classList.contains('hidden');
                if (isHidden) {
                    const currentContent = mainEditor.value;
                    let processedContent = currentContent;
                    document.querySelectorAll('#variables-container input').forEach(input => {
                        const varName = input.name;
                        const varValue = input.value || `{{${varName}}}`;
                        processedContent = processedContent.replace(new RegExp(`\\{\\{${varName}\\}\\}`, 'g'), varValue);
                    });

                    readModeContent.textContent = processedContent;
                    readModeModal.classList.remove('hidden');
                    mainContent.classList.add('read-mode-blur');
                    mainHeader.style.zIndex = 60; // Traz o header para frente
                    readModeIconClosed.classList.add('hidden');
                    readModeIconOpen.classList.remove('hidden');
                } else {
                    readModeModal.classList.add('hidden');
                    mainContent.classList.remove('read-mode-blur');
                    mainHeader.style.zIndex = 20; // Retorna z-index ao normal
                    readModeIconClosed.classList.remove('hidden');
                    readModeIconOpen.classList.add('hidden');
                }
            };

            // --- LÓGICA DE BUSCA E SUBSTITUIÇÃO ---
            const toggleFindReplaceBar = (show) => {
                if (show) {
                    findReplaceBar.classList.add('visible');
                    findInput.focus();
                } else {
                    findReplaceBar.classList.remove('visible');
                    mainEditor.focus();
                    // Limpa o estado da busca ao fechar
                    findState = { matches: [], currentIndex: -1, query: '' };
                    updateFindUI();
                }
            };

            const executeFind = () => {
                const query = findInput.value;
                if (!query) {
                    findState = { matches: [], currentIndex: -1, query: '' };
                    updateFindUI();
                    return;
                }
                
                if (query === findState.query) return; // Não busca de novo se a query for a mesma

                const text = mainEditor.value;
                const regex = new RegExp(query, 'gi');
                let match;
                findState.matches = [];
                while ((match = regex.exec(text)) !== null) {
                    findState.matches.push({
                        index: match.index,
                        length: match[0].length
                    });
                }
                findState.query = query;
                findState.currentIndex = findState.matches.length > 0 ? 0 : -1;
                updateFindUI();
                highlightCurrentMatch();
            };

            const updateFindUI = () => {
                const { matches, currentIndex } = findState;
                const total = matches.length;
                
                if (total > 0) {
                    findCounter.textContent = `${currentIndex + 1}/${total}`;
                } else {
                    findCounter.textContent = '0/0';
                }

                nextBtn.disabled = currentIndex >= total - 1;
                prevBtn.disabled = currentIndex <= 0;
                replaceBtn.disabled = total === 0;
                replaceAllBtn.disabled = total === 0;
            };

            const highlightCurrentMatch = () => {
                mainEditor.focus();
                const { matches, currentIndex } = findState;
                if (currentIndex !== -1) {
                    const match = matches[currentIndex];
                    mainEditor.setSelectionRange(match.index, match.index + match.length);
                }
            };

            const goToNextMatch = () => {
                if (findState.currentIndex < findState.matches.length - 1) {
                    findState.currentIndex++;
                    updateFindUI();
                    highlightCurrentMatch();
                }
            };

            const goToPrevMatch = () => {
                if (findState.currentIndex > 0) {
                    findState.currentIndex--;
                    updateFindUI();
                    highlightCurrentMatch();
                }
            };

            const executeReplace = () => {
                const { matches, currentIndex } = findState;
                if (currentIndex === -1) return;

                const replaceText = replaceInput.value;
                const match = matches[currentIndex];
                const originalText = mainEditor.value;

                mainEditor.value = originalText.substring(0, match.index) + replaceText + originalText.substring(match.index + match.length);
                
                // Após substituir, refaz a busca para atualizar os índices e os botões
                executeFind();
                updateSnippetButtons();
            };

            const executeReplaceAll = () => {
                const { matches } = findState;
                if (matches.length === 0) return;

                const findText = findInput.value;
                const replaceText = replaceInput.value;
                const regex = new RegExp(findText, 'gi');
                
                mainEditor.value = mainEditor.value.replace(regex, replaceText);

                // Limpa o estado da busca e atualiza os botões
                executeFind();
                updateSnippetButtons();
            };

            const populateGraphFilters = () => {
                graphProjectFilter.innerHTML = '<option value="all">All Projects</option>';
                const existingProjects = [...new Set(prompts.map(p => p.project).filter(Boolean))].sort();
                existingProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    graphProjectFilter.appendChild(option);
                });
            };

            // =================================================================
            // FUNÇÃO DO GRÁFICO DE DEPENDÊNCIAS
            // =================================================================
            const renderDependencyGraph = (filters = {}) => {
                const svg = d3.select("#dependency-graph-svg");
                const container = svg.node().parentElement;
                const width = container.clientWidth;
                const height = container.clientHeight;

                svg.selectAll("*").remove(); 

                let promptsToRender = [...prompts];
                if (filters.project && filters.project !== 'all') {
                    promptsToRender = prompts.filter(p => p.project === filters.project);
                }

                if (promptsToRender.length === 0) {
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .style("fill", "var(--text-muted-dark)")
                        .text("No prompts to display for the selected filter.");
                    return;
                }

                const nodes = promptsToRender.map(p => ({
                    id: p.id,
                    title: p.title,
                    version: p.version,
                    group: p.promptId,
                    promptData: p 
                }));
                const nodeIds = new Set(nodes.map(n => n.id));

                const links = prompts
                    .filter(p => p.parentId !== null && nodeIds.has(p.id) && nodeIds.has(p.parentId))
                    .map(p => ({
                        source: p.parentId,
                        target: p.id
                    }));

                const simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(150).strength(0.5))
                    .force("charge", d3.forceManyBody().strength(-400))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("x", d3.forceX(width / 2).strength(0.05))
                    .force("y", d3.forceY(height / 2).strength(0.05));

                const g = svg.append("g");
                
                g.append('defs').append('marker')
                    .attr('id', 'arrowhead')
                    .attr('viewBox', '-0 -5 10 10')
                    .attr('refX', 23)
                    .attr('refY', 0)
                    .attr('orient', 'auto')
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .append('svg:path')
                    .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                    .attr('fill', 'var(--border-dark)');

                const link = g.append("g")
                    .attr("class", "graph-links")
                    .selectAll("line")
                    .data(links)
                    .join("line")
                    .attr("class", "graph-link")
                    .attr("marker-end", "url(#arrowhead)");

                const node = g.append("g")
                    .attr("class", "graph-nodes")
                    .selectAll("g")
                    .data(nodes)
                    .join("g")
                    .attr("class", "graph-node")
                    .call(drag(simulation));

                const color = d3.scaleOrdinal(d3.schemeTableau10);

                node.append("circle")
                    .attr("r", 12)
                    .attr("fill", d => color(d.group));

                node.append("text")
                    .text(d => `${d.title} v${d.version}`)
                    .attr('y', -20);

                node.on('mouseover', (event, d) => {
                    const promptData = d.promptData;
                    graphTooltip.style.opacity = 1;
                    graphTooltip.innerHTML = `
                        <h3 class="font-bold text-base mb-2 truncate" style="color: var(--accent-fuchsia);">${promptData.title}</h3>
                        <div class="space-y-1">
                            <p><strong class="text-[--text-muted-dark] font-normal">Project:</strong> ${promptData.project || 'N/A'}</p>
                            <p><strong class="text-[--text-muted-dark] font-normal">LLM:</strong> ${promptData.llm || 'N/A'}</p>
                        </div>
                        <div class="mt-3 pt-2 border-t border-[--border-dark] grid grid-cols-3 gap-2 text-center font-mono">
                            <div><p class="text-[--text-muted-dark] text-xs">Temp</p><p class="font-semibold text-sm">${promptData.temperature}</p></div>
                            <div><p class="text-[--text-muted-dark] text-xs">Top P</p><p class="font-semibold text-sm">${promptData.topP}</p></div>
                            <div><p class="text-[--text-muted-dark] text-xs">Effort</p><p class="font-semibold text-sm">${promptData.effort}</p></div>
                        </div>
                    `;
                    const svgRect = svg.node().getBoundingClientRect();
                    graphTooltip.style.left = (event.clientX - svgRect.left + 15) + 'px';
                    graphTooltip.style.top = (event.clientY - svgRect.top + 15) + 'px';
                })
                .on('mouseout', () => {
                    graphTooltip.style.opacity = 0;
                });

                node.on("click", async (event, d) => {
                    if (isCreatingConnection) {
                        if (!firstNodeForConnection) {
                            firstNodeForConnection = d;
                            d3.select(event.currentTarget).classed('selected-for-connection', true);
                        } else {
                            if (firstNodeForConnection.id !== d.id) {
                                const childPrompt = prompts.find(p => p.id === d.id);
                                if (childPrompt) {
                                    childPrompt.parentId = firstNodeForConnection.id;
                                    savePromptsToStorage();
                                    renderDependencyGraph({ project: graphProjectFilter.value });
                                    await upsertItem('prompts', childPrompt);
                                }
                            }
                            isCreatingConnection = false;
                            firstNodeForConnection = null;
                            createConnectionBtn.classList.remove('active');
                            d3.selectAll('.graph-node').classed('selected-for-connection', false);
                        }
                    } else {
                        loadVersionIntoEditor(d.id);
                        dependencyGraphModal.classList.add('hidden');
                    }
                });

                link.on('click', (event, d) => {
                    event.stopPropagation();
                    link.classed('selected', false);
                    d3.select(event.currentTarget).classed('selected', true);
                    selectedLinkForDeletion = d;
                    deleteConnectionBtn.disabled = false;
                });

                svg.on('click', () => {
                    link.classed('selected', false);
                    selectedLinkForDeletion = null;
                    deleteConnectionBtn.disabled = true;
                });

                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node.attr("transform", d => `translate(${d.x},${d.y})`);
                });

                svg.call(d3.zoom().on("zoom", (event) => {
                    g.attr("transform", event.transform);
                }));

                function drag(simulation) {
                    function dragstarted(event, d) {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x; d.fy = d.y;
                    }
                    function dragged(event, d) {
                        d.fx = event.x; d.fy = event.y;
                    }
                    function dragended(event, d) {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null; d.fy = null;
                    }
                    return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
                }
            };

            // --- LÓGICA DO SNIPPET COPY (NOVO) ---
            const updateSnippetButtons = () => {
                snippetButtonsOverlay.innerHTML = '';
                snippets = [];
                const text = mainEditor.value;
                
                const openTags = [];
                const tagRegex = /<(\/)?([a-zA-Z][\w-]*)/g;
                let match;

                while ((match = tagRegex.exec(text)) !== null) {
                    const isClosing = match[1] === '/';
                    const tagName = match[2];
                    const tagIndex = match.index;

                    if (isClosing) {
                        for (let i = openTags.length - 1; i >= 0; i--) {
                            if (openTags[i].name === tagName && !openTags[i].closed) {
                                openTags[i].closed = true;
                                const blockStartIndex = openTags[i].index;
                                const blockEndIndex = tagIndex + match[0].length + 1;
                                const blockContent = text.substring(blockStartIndex, blockEndIndex);
                                
                                const textUpToStart = text.substring(0, blockStartIndex);
                                const startLineNumber = textUpToStart.split('\n').length - 1;

                                snippets.push({ content: blockContent });
                                const snippetIndex = snippets.length - 1;

                                const button = document.createElement('button');
                                button.className = 'copy-snippet-btn';
                                button.title = 'Copy XML Snippet';
                                button.dataset.snippetIndex = snippetIndex;
                                button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;

                                const styles = getComputedStyle(mainEditor);
                                const lineHeight = parseFloat(styles.lineHeight);
                                const paddingTop = parseFloat(styles.paddingTop);
                                const scrollTop = mainEditor.scrollTop;
                                const scrollLeft = mainEditor.scrollLeft;

                                button.style.top = `${(startLineNumber * lineHeight) + paddingTop - scrollTop}px`;
                                button.style.right = `${15 - scrollLeft}px`;

                                snippetButtonsOverlay.appendChild(button);
                                break; 
                            }
                        }
                    } else {
                        openTags.push({ name: tagName, index: tagIndex, closed: false });
                    }
                }
            };

            const renderPromptTags = (tags = []) => {
                tagsContainer.innerHTML = '';
                const projectTag = `#${projectInput.value.trim().toLowerCase().replace(/\s+/g, '-')}`;
                const llmTag = `#${llmSelect.value.toLowerCase()}`;
                
                if (projectInput.value.trim()) {
                    tagsContainer.appendChild(createTagEl(projectTag, true));
                }
                if (llmSelect.value !== 'generic') {
                    tagsContainer.appendChild(createTagEl(llmTag, true));
                }

                tags.forEach(tag => {
                    if (tag !== projectTag && tag !== llmTag) {
                        const tagEl = createTagEl(tag, false);
                        tagsContainer.appendChild(tagEl);
                    }
                });
            };

            const createTagEl = (tag, isAuto) => {
                const tagEl = document.createElement('div');
                tagEl.className = isAuto ? 'prompt-tag auto-tag' : 'prompt-tag';
                let html = `<span>${tag}</span>`;
                if (!isAuto) {
                    html += `<button class="remove-tag-btn" data-tag="${tag}">&times;</button>`;
                }
                tagEl.innerHTML = html;
                return tagEl;
            };

            const getAllUniqueTags = () => {
                const allTags = new Set();
                prompts.forEach(p => {
                    if (p.tags) {
                        p.tags.forEach(tag => allTags.add(tag));
                    }
                });
                return [...allTags].sort();
            }

            const renderNavigationMap = () => {
                const content = mainEditor.value;
                const xmlTagRegex = /<([a-zA-Z][\w-]*)/g;
                let match;
                const tags = [];

                while ((match = xmlTagRegex.exec(content)) !== null) {
                    tags.push({
                        name: match[1],
                        index: match.index
                    });
                }

                if (tags.length === 0) {
                    navigationMap.innerHTML = '';
                    navigationMap.classList.add('hidden');
                    return;
                }

                navigationMap.innerHTML = '<span class="text-xs font-bold text-[--text-muted-dark] self-center">Quick Nav:</span>';
                tags.forEach(tag => {
                    const tagEl = document.createElement('button');
                    tagEl.className = 'nav-map-tag';
                    tagEl.textContent = tag.name;
                    tagEl.dataset.index = tag.index;
                    navigationMap.appendChild(tagEl);
                });
                navigationMap.classList.remove('hidden');
            };

            // --- LÓGICA DO GERENCIADOR DE LISTAS ---
            const renderListManager = () => {
                xmlTagsManagerContainer.innerHTML = '';
                varLibraryManagerContainer.innerHTML = '';
                generalTagsManagerContainer.innerHTML = '';
                llmManagerContainer.innerHTML = '';

                const createManagerItemEl = (value, type, options = {}) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'manager-tag flex justify-between items-center';
                    itemEl.dataset.value = value;
                    itemEl.dataset.type = type;
                    if (options.category) {
                        itemEl.dataset.category = options.category;
                    }
                    itemEl.innerHTML = `
                        <span class="truncate" contenteditable="true">${value}</span>
                        <button class="remove-tag-btn p-1">&times;</button>
                    `;
                    return itemEl;
                };

                xmlTags.sort().forEach(tag => xmlTagsManagerContainer.appendChild(createManagerItemEl(tag, 'xml')));
                varLibrary.sort().forEach(tag => varLibraryManagerContainer.appendChild(createManagerItemEl(tag, 'var')));
                getAllUniqueTags().forEach(tag => generalTagsManagerContainer.appendChild(createManagerItemEl(tag, 'general')));

                Object.keys(llmList).sort().forEach(category => {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.className = 'mb-3';
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'manager-tag flex justify-between items-center font-bold bg-[#2a2a2a]';
                    categoryHeader.dataset.value = category;
                    categoryHeader.dataset.type = 'llm-category';
                    categoryHeader.innerHTML = `
                        <span class="truncate" contenteditable="true">${category}</span>
                        <button class="remove-tag-btn p-1">&times;</button>
                    `;
                    
                    const modelsContainer = document.createElement('div');
                    modelsContainer.className = 'pl-2 mt-2 space-y-2';
                    
                    llmList[category].sort().forEach(model => {
                        modelsContainer.appendChild(createManagerItemEl(model, 'llm-model', { category }));
                    });

                    const addModelWrapper = document.createElement('div');
                    addModelWrapper.className = 'flex gap-2 mt-2';
                    addModelWrapper.innerHTML = `
                        <input type="text" placeholder="New model..." class="form-control w-full rounded-md py-1 px-2 text-xs">
                        <button class="action-button primary px-2 text-xs" data-action="add-model" data-category="${category}">+</button>
                    `;
                    
                    categoryContainer.appendChild(categoryHeader);
                    categoryContainer.appendChild(modelsContainer);
                    categoryContainer.appendChild(addModelWrapper);
                    llmManagerContainer.appendChild(categoryContainer);
                });
            };

            const updateListItem = (type, oldVal, newVal, options = {}) => {
                if (!newVal || oldVal === newVal) return;

                if (type === 'xml') {
                    const index = xmlTags.indexOf(oldVal);
                    if (index > -1 && !xmlTags.includes(newVal)) {
                        xmlTags[index] = newVal;
                        saveXmlTagsToStorage();
                    }
                } else if (type === 'var') {
                    const index = varLibrary.indexOf(oldVal);
                    if (index > -1 && !varLibrary.includes(newVal)) {
                        varLibrary[index] = newVal;
                        saveVarLibraryToStorage();
                    }
                } else if (type === 'general') {
                    prompts.forEach(p => {
                        if (p.tags && p.tags.includes(oldVal)) {
                            p.tags = p.tags.map(t => t === oldVal ? newVal : t);
                        }
                    });
                    savePromptsToStorage();
                } else if (type === 'llm-category') {
                    if (llmList[oldVal] && !llmList[newVal]) {
                        llmList[newVal] = llmList[oldVal];
                        delete llmList[oldVal];
                        saveLlmListToStorage();
                        updateGlobalList('llm_list', llmList);
                        populateLlmSelect();
                    }
                } else if (type === 'llm-model') {
                    const { category } = options;
                    if (llmList[category]) {
                        const index = llmList[category].indexOf(oldVal);
                        if (index > -1 && !llmList[category].includes(newVal)) {
                            llmList[category][index] = newVal;
                            prompts.forEach(p => { if (p.llm === oldVal) p.llm = newVal; });
                            saveLlmListToStorage();
                            savePromptsToStorage();
                            populateLlmSelect();
                        }
                    }
                }
                renderListManager();
            };

            // --- LÓGICA DA GALERIA DE INPUTS ---
            const renderInputGallery = () => {
                inputGalleryList.innerHTML = '';
                inputGallery.sort((a,b) => a.name.localeCompare(b.name)).forEach(input => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'input-gallery-item';
                    itemEl.dataset.id = input.id;
                    if(input.id === selectedInputId) {
                        itemEl.classList.add('selected');
                    }
                    itemEl.innerHTML = `
                        <span class="truncate flex-grow">${input.name}</span>
                        <button class="remove-btn p-1" data-action="delete-input" data-id="${input.id}">
                            <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    inputGalleryList.appendChild(itemEl);
                });
            };

            const clearInputEditor = () => {
                selectedInputId = null;
                inputGalleryId.value = '';
                inputGalleryName.value = '';
                inputGalleryEditor.value = '';
                inputGalleryName.focus();
                renderInputGallery();
            };

            const loadInputForEditing = (id) => {
                const input = inputGallery.find(i => i.id === id);
                if (input) {
                    selectedInputId = id;
                    inputGalleryId.value = input.id;
                    inputGalleryName.value = input.name;
                    inputGalleryEditor.value = input.content;
                    renderInputGallery();
                }
            };

            const saveCurrentInput = async () => {
                const name = inputGalleryName.value.trim();
                const content = inputGalleryEditor.value.trim();
                const currentId = selectedInputId;

                if (!name || !content) {
                    showModal('Error', 'Input name and content cannot be empty.', [{ text: 'OK', className: 'action-button primary', onClick: hideModal }]);
                    return;
                }

                let itemToSave;

                if (currentId) { // Editando um existente
                    const index = inputGallery.findIndex(i => i.id === currentId);
                    if (index > -1) {
                        inputGallery[index].name = name;
                        inputGallery[index].content = content;
                        itemToSave = inputGallery[index];
                    }
                } else { // Criando um novo
                    const newId = crypto.randomUUID();
                    itemToSave = { id: newId, name, content };
                    inputGallery.push(itemToSave);
                    selectedInputId = newId;
                }
                
                if (itemToSave) {
                    await upsertItem('input_gallery', itemToSave); // Salva apenas o item modificado/novo
                }

                saveInputGalleryToStorage();
                renderInputGallery();
            };

            const deleteInputFromGallery = async (id) => {
                // Deleta primeiro do Supabase
                await deleteItem('input_gallery', id);

                // Depois atualiza o estado local
                inputGallery = inputGallery.filter(i => i.id !== id);
                saveInputGalleryToStorage();
                
                if (selectedInputId === id) {
                    clearInputEditor();
                } else {
                    renderInputGallery();
                }
            };

            // --- LÓGICA DO NODE FLOW ---
            const renderNodeFlowPrompts = () => {
                nodeFlowPromptList.innerHTML = '';
                const selectedProject = nodeFlowProjectFilter.value;

                const filteredPrompts = selectedProject === 'all' 
                    ? prompts 
                    : prompts.filter(p => p.project === selectedProject);

                const groupedPrompts = filteredPrompts.reduce((acc, p) => {
                    if (!acc[p.promptId]) {
                        acc[p.promptId] = { title: p.title, project: p.project, versions: [] };
                    }
                    acc[p.promptId].versions.push(p);
                    return acc;
                }, {});

                Object.values(groupedPrompts).forEach(group => {
                    group.versions.sort((a, b) => parseFloat(b.version) - parseFloat(a.version)).forEach(version => {
                         const card = document.createElement('div');
                         card.className = 'node-flow-prompt-card p-2 rounded-md';
                         card.draggable = true;
                         card.dataset.versionId = version.id;
                         card.innerHTML = `
                             <h4 class="font-semibold text-sm truncate">${version.title} (v${version.version})</h4>
                             <p class="text-xs text-[--text-muted-dark] truncate">${version.project || 'No Project'}</p>
                         `;
                         nodeFlowPromptList.appendChild(card);
                    });
                });
            };
            
            const renderFlowNodes = () => {
                nodeFlowContent.innerHTML = '';
                flowNodes.forEach(nodeData => {
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'flow-node gallery-card'; // Reutiliza o estilo do gallery-card
                    nodeEl.id = `flow-node-${nodeData.id}`;
                    nodeEl.style.left = `${nodeData.x}px`;
                    nodeEl.style.top = `${nodeData.y}px`;
                    nodeEl.dataset.nodeId = nodeData.id;

                    const prompt = prompts.find(p => p.id === nodeData.promptId);
                    if (prompt) {
                        let dependencyTitle = 'N/A';
                         if (prompt.parentId) {
                             const parentPrompt = prompts.find(p => p.id === prompt.parentId);
                             if (parentPrompt) dependencyTitle = `${parentPrompt.title} (v${parentPrompt.version})`;
                         }
                        nodeEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-base mb-2 truncate pr-2" style="color: var(--accent-fuchsia);">${prompt.title}</h3>
                                <span class="text-xs font-mono bg-[#333] text-[#ccc] rounded-full px-2 py-0.5">v${prompt.version}</span>
                            </div>
                            <div class="space-y-1 flex-grow text-xs">
                                <p><strong class="text-[--text-muted-dark] font-normal">Project:</strong> ${prompt.project || 'N/A'}</p>
                                <p><strong class="text-[--text-muted-dark] font-normal">LLM:</strong> ${prompt.llm || 'N/A'}</p>
                                <p class="truncate"><strong class="text-[--text-muted-dark] font-normal">Dependence:</strong> ${dependencyTitle}</p>
                            </div>
                            <div class="mt-3 pt-2 border-t border-[--border-dark] grid grid-cols-3 gap-2 text-center font-mono">
                                <div><p class="text-[--text-muted-dark] text-xs">Temp</p><p class="font-semibold text-sm">${prompt.temperature}</p></div>
                                <div><p class="text-[--text-muted-dark] text-xs">Top P</p><p class="font-semibold text-sm">${prompt.topP}</p></div>
                                <div><p class="text-[--text-muted-dark] text-xs">Effort</p><p class="font-semibold text-sm">${prompt.effort}</p></div>
                            </div>
                            <div class="connector output" data-node-id="${nodeData.id}"></div>
                        `;
                    } else {
                         nodeEl.innerHTML = `Prompt not found`;
                    }
                    nodeFlowContent.appendChild(nodeEl);
                });
            }

            const renderFlowConnections = () => {
                const svg = d3.select("#connections-group");
                svg.selectAll("path").remove();
                
                // Pega a posição do canvas para converter as coordenadas do viewport
                const canvasRect = nodeFlowCanvas.getBoundingClientRect();
            
                flowConnections.forEach(conn => {
                    const sourceNodeEl = document.getElementById(`flow-node-${conn.source}`);
                    const targetNodeEl = document.getElementById(`flow-node-${conn.target}`);
                    if (sourceNodeEl && targetNodeEl) {
                        const sourceRect = sourceNodeEl.getBoundingClientRect();
                        const targetRect = targetNodeEl.getBoundingClientRect();
            
                        const startX = sourceRect.right - canvasRect.left;
                        const startY = sourceRect.top + (sourceRect.height / 2) - canvasRect.top;
                        const endX = targetRect.left - canvasRect.left;
                        const endY = targetRect.top + (targetRect.height / 2) - canvasRect.top;
            
                        svg.append('path')
                            .attr('d', `M ${startX} ${startY} C ${startX + 60} ${startY} ${endX - 60} ${endY} ${endX} ${endY}`)
                            .attr('class', 'connection-line')
                            .attr('data-source', conn.source)
                            .attr('data-target', conn.target);
                    }
                });
            }
            
            const renderSavedFlowsList = () => {
                savedFlowsDropdown.innerHTML = '<option value="">Load a saved flow...</option>';
                savedFlows.forEach(flow => {
                    const option = document.createElement('option');
                    option.value = flow.name;
                    option.textContent = flow.name;
                    savedFlowsDropdown.appendChild(option);
                });
            };

            const loadFlow = (flowName) => {
                const flow = savedFlows.find(f => f.name === flowName);
                if (flow) {
                    flowNodes = flow.nodes;
                    flowConnections = flow.connections;
                    renderFlowNodes();
                    renderFlowConnections();
                }
            };

            // --- MANIPULADORES DE EVENTOS ---
            versionsHistoryList.addEventListener('click', (e) => {
                const target = e.target;
                const item = target.closest('.version-item');
                const header = target.closest('.prompt-group-header');
                const deleteGroupBtn = target.closest('[data-action="delete-group"]');

                if (deleteGroupBtn) {
                    e.stopPropagation();
                    const promptId = parseInt(deleteGroupBtn.dataset.promptId, 10);
                    showDeleteModal('group', promptId);
                } else if (header) {
                    const promptId = header.dataset.promptId;
                    if (expandedPromptGroups.has(promptId)) {
                        expandedPromptGroups.delete(promptId);
                    } else {
                        expandedPromptGroups.add(promptId);
                    }
                    renderVersionsList();
                } else if (target.matches('input[type="checkbox"]')) {
                    const versionId = parseInt(target.dataset.id, 10);
                    const promptId = parseInt(target.dataset.promptId, 10);
                    
                    if (target.checked) {
                        if (activeComparisonPromptId !== null && activeComparisonPromptId !== promptId) {
                            versionsToCompare.clear();
                            activeComparisonPromptId = null;
                        }
                        
                        versionsToCompare.add(versionId);
                        activeComparisonPromptId = promptId;

                        if (versionsToCompare.size > 2) {
                            const firstId = versionsToCompare.values().next().value;
                            versionsToCompare.delete(firstId);
                        }
                    } else {
                        versionsToCompare.delete(versionId);
                        if (versionsToCompare.size === 0) {
                            activeComparisonPromptId = null;
                        }
                    }

                    document.querySelectorAll('#versions-history-list input[type="checkbox"]').forEach(cb => {
                        const cbVersionId = parseInt(cb.dataset.id, 10);
                        const cbPromptId = parseInt(cb.dataset.promptId, 10);
                        cb.checked = versionsToCompare.has(cbVersionId);
                        if (activeComparisonPromptId !== null) {
                            cb.disabled = cbPromptId !== activeComparisonPromptId;
                        } else {
                            cb.disabled = false;
                        }
                    });

                    compareVersionsBtn.disabled = versionsToCompare.size !== 2;

                } else if (item) {
                    const actionTarget = target.closest('[data-action="select"]');
                     if (actionTarget) {
                         loadVersionIntoEditor(parseInt(actionTarget.dataset.id, 10));
                     }
                }
            });

            statusContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.status-option');
                if(target) updateStatusSelectorUI(target.dataset.status);
            });

            statusFilterContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.filter-tag-btn');
                if (target) {
                    activeStatusFilter = target.dataset.filter;
                    updateStatusFilterUI();
                    renderVersionsList();
                }
            });

            mainEditor.addEventListener('input', () => {
                updateEditorStats();
                renderVariables();
                renderNavigationMap();
                updateSnippetButtons();
            });
            mainEditor.addEventListener('scroll', updateSnippetButtons);

            searchInput.addEventListener('input', () => renderVersionsList());

            copyPromptBtn.addEventListener('click', () => {
                let textToCopy = mainEditor.value;
                document.querySelectorAll('#variables-container input').forEach(input => {
                    const varName = input.name;
                    const varValue = input.value;
                    textToCopy = textToCopy.replace(new RegExp(`\\{\\{${varName}\\}\\}`, 'g'), varValue);
                });
                
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        copyPromptBtn.classList.add('text-green-500');
                        setTimeout(() => {
                            copyPromptBtn.classList.remove('text-green-500');
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textArea);
            });

            deleteVersionBtn.addEventListener('click', () => {
                if (selectedVersionId) showDeleteModal('version', selectedVersionId);
                else showValidationAlert('No version selected to delete.');
            });

            addPromptBtn.addEventListener('click', clearEditorForNewPrompt);
            addMajorVersionBtn.addEventListener('click', () => saveVersion(true));
            addMinorVersionBtn.addEventListener('click', () => saveVersion(false));
            forkVersionBtn.addEventListener('click', forkVersion);
            const saveChanges = async () => {
                if (!selectedVersionId) {
                    showValidationAlert('No prompt selected to save changes.');
                    return;
                }
                const promptIndex = prompts.findIndex(p => p.id === selectedVersionId);
                if (promptIndex === -1) return;

                const promptToUpdate = { ...prompts[promptIndex] }; // Cria uma cópia para editar

                promptToUpdate.title = titleInput.value.trim();
                promptToUpdate.project = projectInput.value.trim();
                promptToUpdate.content = mainEditor.value;
                promptToUpdate.comments = commentsTextarea.value;
                promptToUpdate.llm = llmSelect.value;
                promptToUpdate.status = document.querySelector('.status-option.active')?.dataset.status || promptToUpdate.status;
                promptToUpdate.temperature = parseFloat(temperatureSlider.value);
                promptToUpdate.topP = parseFloat(topPSlider.value);
                promptToUpdate.effort = effortLevels[effortSlider.value];
                promptToUpdate.date = new Date().toISOString();
                promptToUpdate.tags = [...tagsContainer.querySelectorAll('.prompt-tag span')].map(span => span.textContent);

                await upsertItem('prompts', promptToUpdate); // Salva no Supabase

                prompts[promptIndex] = promptToUpdate; // Atualiza o estado local
                renderVersionsList();
                updateSnippetButtons();
            };

            document.getElementById('save-changes-btn').addEventListener('click', saveChanges);
            downloadJsonBtn.addEventListener('click', () => downloadFile('json'));
            downloadMdBtn.addEventListener('click', () => downloadFile('md'));

            // Eventos dos Sliders
            temperatureSlider.addEventListener('input', (e) => temperatureValue.textContent = parseFloat(e.target.value).toFixed(1));
            topPSlider.addEventListener('input', (e) => topPValue.textContent = parseFloat(e.target.value).toFixed(2));
            effortSlider.addEventListener('input', (e) => effortValue.textContent = effortLevels[e.target.value]);
            
            // --- Eventos da Galeria e Modais ---
            galleryBtn.addEventListener('click', () => {
                renderGallery();
                galleryModal.classList.remove('hidden');
            });

            closeGalleryBtn.addEventListener('click', () => galleryModal.classList.add('hidden'));
            galleryModal.addEventListener('click', (e) => {
                if (e.target === galleryModal) galleryModal.classList.add('hidden');
            });

            projectsBtn.addEventListener('click', () => {
                renderProjectsView();
                projectsModal.classList.remove('hidden');
            });
            closeProjectsBtn.addEventListener('click', () => projectsModal.classList.add('hidden'));
            projectsModal.addEventListener('click', (e) => {
                if (e.target === projectsModal) projectsModal.classList.add('hidden');
            });
            projectsListContainer.addEventListener('click', (e) => {
                const rowTarget = e.target.closest('tr[data-id]');
                const commentBtn = e.target.closest('[data-action="view-comments"]');

                if (commentBtn) {
                    e.stopPropagation(); // Impede que o clique na linha seja disparado
                    const promptId = parseInt(commentBtn.dataset.id, 10);
                    showCommentsViewer(promptId);
                } else if (rowTarget) {
                    const promptId = parseInt(rowTarget.dataset.id, 10);
                    loadVersionIntoEditor(promptId);
                    projectsModal.classList.add('hidden');
                }
            });

            templatesBtn.addEventListener('click', () => {
                renderTemplatesGrid();
                templatesModal.classList.remove('hidden');
            });
            closeTemplatesBtn.addEventListener('click', () => templatesModal.classList.add('hidden'));
            templatesModal.addEventListener('click', (e) => {
                if (e.target === templatesModal) templatesModal.classList.add('hidden');
            });
            
            templatesGridContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.gallery-card');
                if (!card) return;

                const actionButton = e.target.closest('[data-action]');
                const templateId = parseInt(card.dataset.id, 10);
                const template = templates.find(t => t.id === templateId);
                if (!template) return;

                const action = actionButton ? actionButton.dataset.action : 'load-template';

                if (action === 'load-template') {
                    clearEditorForNewPrompt();
                    titleInput.value = template.title;
                    projectInput.value = template.project;
                    mainEditor.value = template.content;
                    llmSelect.value = template.llm;
                    dependencySelect.value = template.parentId || '';
                    updateSlidersUI(template);
                    updateEditorStats();
                    renderVariables();
                    renderPromptTags(template.tags);
                    templatesModal.classList.add('hidden');
                    updateSnippetButtons();
                } else if (action === 'delete-template') {
                    showModal(
                        'Confirm Deletion',
                        `Are you sure you want to delete the template "${template.name}"?`,
                        [
                            { text: 'Cancel', className: 'action-button', onClick: hideModal },
                            { 
                                text: 'Delete', 
                                className: 'action-button bg-[--accent-red] text-white border-[--accent-red-hover] hover:bg-[--accent-red-hover]', 
                                onClick: async () => {
                                    templates = templates.filter(t => t.id !== templateId);
                                    saveTemplatesToStorage();
                                    await deleteItem('templates', templateId);
                                    renderTemplatesGrid();
                                    hideModal();
                                }
                            }
                        ]
                    );
                }
            });

            saveAsTemplateBtn.addEventListener('click', () => {
                const content = mainEditor.value.trim();
                if (!content) {
                    showValidationAlert('The editor is empty. Write something to save as a template.');
                    return;
                }

                const currentTags = [...tagsContainer.querySelectorAll('.prompt-tag span')].map(span => span.textContent);

                const templateData = {
                    title: titleInput.value.trim(),
                    project: projectInput.value.trim(),
                    content: content,
                    llm: llmSelect.value,
                    temperature: parseFloat(temperatureSlider.value),
                    topP: parseFloat(topPSlider.value),
                    effort: effortLevels[effortSlider.value],
                    parentId: dependencySelect.value ? parseInt(dependencySelect.value, 10) : null,
                    tags: currentTags
                };

                showModal(
                    'Save as Template',
                    'Enter a name for this template:',
                    [
                        { text: 'Cancel', className: 'action-button', onClick: hideModal },
                        { 
                            text: 'Save', 
                            className: 'action-button primary', 
                            onClick: async () => {
                                const templateName = document.getElementById('confirm-modal-input').value.trim();
                                if (templateName) {
                                    const newTemplate = { ...templateData, name: templateName, id: Date.now() };
                                    templates.push(newTemplate);
                                    saveTemplatesToStorage();
                                    await upsertItem('templates', newTemplate);
                                    hideModal();
                                    setTimeout(() => {
                                        showModal('Success', `Template "${templateName}" saved.`, [{ text: 'OK', className: 'action-button primary', onClick: async () => await hideModal }]);
                                    }, 300);
                                }
                            } 
                        }
                    ],
                    { showInput: true, inputPlaceholder: 'Template name...' }
                );
            });

            dependencyTagContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.dependency-tag');
                if (target) {
                    const dependencyId = parseInt(target.dataset.dependencyId, 10);
                    showDependencyViewer(dependencyId);
                }
            });

            closeDependencyViewerBtn.addEventListener('click', () => dependencyViewerModal.classList.add('hidden'));
            dependencyViewerModal.addEventListener('click', (e) => {
                if (e.target === dependencyViewerModal) dependencyViewerModal.classList.add('hidden');
            });
            
            closeCommentsViewerBtn.addEventListener('click', () => commentsViewerModal.classList.add('hidden'));
            commentsViewerModal.addEventListener('click', (e) => {
                if (e.target === commentsViewerModal) commentsViewerModal.classList.add('hidden');
            });

            readModeBtn.addEventListener('click', toggleReadMode);
            readModeModal.addEventListener('click', (e) => {
                if (e.target === readModeModal) {
                    toggleReadMode();
                }
            });
            
            compareVersionsBtn.addEventListener('click', () => {
                const [id1, id2] = Array.from(versionsToCompare);
                let version1 = prompts.find(p => p.id === id1);
                let version2 = prompts.find(p => p.id === id2);

                if (version1 && version2) {
                    // Garante que a versão 1 seja sempre a mais antiga
                    if (parseFloat(version1.version) > parseFloat(version2.version)) {
                        [version1, version2] = [version2, version1];
                    }

                    const dmp = new diff_match_patch();
                    
                    const diff1 = dmp.diff_main(version1.content, version2.content);
                    dmp.diff_cleanupSemantic(diff1);
                    
                    const diff2 = dmp.diff_main(version2.content, version1.content);
                    dmp.diff_cleanupSemantic(diff2);
                    
                    const cleanHtml = (html) => {
                        return html
                            .replace(/&para;/g, '')
                            .replace(/ style="background:(#e6ffe6|#ffe6e6);"/gi, '');
                    };

                    diffModalTitle.textContent = `Comparing v${version1.version} vs v${version2.version}`;
                    diffTitleA.textContent = `Version ${version1.version}`;
                    diffTitleB.textContent = `Version ${version2.version}`;
                    diffPanelA.innerHTML = cleanHtml(dmp.diff_prettyHtml(diff1));
                    diffPanelB.innerHTML = cleanHtml(dmp.diff_prettyHtml(diff2));

                    diffModal.classList.remove('hidden');
                }
            });
            closeDiffModalBtn.addEventListener('click', () => diffModal.classList.add('hidden'));
            diffModal.addEventListener('click', (e) => {
                if (e.target === diffModal) {
                    diffModal.classList.add('hidden');
                }
            });

            // --- EVENTOS DE BUSCA E SUBSTITUIÇÃO ---
            findBtn.addEventListener('click', () => toggleFindReplaceBar(true));
            closeFindBtn.addEventListener('click', () => toggleFindReplaceBar(false));
            findInput.addEventListener('input', executeFind);
            findInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    goToNextMatch();
                }
            });
            nextBtn.addEventListener('click', goToNextMatch);
            prevBtn.addEventListener('click', goToPrevMatch);
            replaceBtn.addEventListener('click', executeReplace);
            replaceAllBtn.addEventListener('click', executeReplaceAll);

            // --- EVENTOS DO GRÁFICO ---
            graphViewBtn.addEventListener('click', () => {
                dependencyGraphModal.classList.remove('hidden');
                populateGraphFilters();
                // Pequeno delay para garantir que o container tenha as dimensões corretas antes de renderizar
                setTimeout(() => renderDependencyGraph({ project: graphProjectFilter.value }), 50); 
            });
            closeDependencyGraphBtn.addEventListener('click', () => dependencyGraphModal.classList.add('hidden'));
            dependencyGraphModal.addEventListener('click', e => {
                if (e.target === dependencyGraphModal) {
                    dependencyGraphModal.classList.add('hidden');
                }
            });
            graphProjectFilter.addEventListener('change', () => {
                const selectedProject = graphProjectFilter.value;
                renderDependencyGraph({ project: selectedProject });
            });
            createConnectionBtn.addEventListener('click', (e) => {
                isCreatingConnection = !isCreatingConnection;
                e.currentTarget.classList.toggle('active', isCreatingConnection);
                // Se o modo de conexão for desativado, reseta o estado
                if (!isCreatingConnection) {
                    firstNodeForConnection = null;
                    d3.selectAll('.graph-node').classed('selected-for-connection', false);
                }
            });
            deleteConnectionBtn.addEventListener('click', async () => {
                if (selectedLinkForDeletion) {
                    const childPrompt = prompts.find(p => p.id === selectedLinkForDeletion.target.id);
                    if (childPrompt) {
                        childPrompt.parentId = null;
                        savePromptsToStorage();
                        await upsertItem('prompts', childPrompt);
                        // Re-render the graph with the current filter
                        renderDependencyGraph({ project: graphProjectFilter.value });
                        // Reset state
                        selectedLinkForDeletion = null;
                        deleteConnectionBtn.disabled = true;
                    }
                }
            });

            // --- EVENTOS DAS TAGS ---
            tagsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.remove-tag-btn');
                if (target) {
                    target.parentElement.remove();
                }
            });
            
            projectInput.addEventListener('input', () => renderPromptTags([...tagsContainer.querySelectorAll('.prompt-tag:not(.auto-tag) span')].map(s => s.textContent)));
            llmSelect.addEventListener('change', () => renderPromptTags([...tagsContainer.querySelectorAll('.prompt-tag:not(.auto-tag) span')].map(s => s.textContent)));

            // --- EVENTOS DA BIBLIOTECA DE VARIÁVEIS E XML ---
            const setupDropdown = (input, dropdown, library, onSelect, onAdd) => {
                const renderDropdown = (showAll = false) => {
                    const filter = input.value.toLowerCase();
                    const items = library(); // Get the items from the provided function
                    const itemsToShow = (showAll) ? items : items.filter(item => item.toLowerCase().includes(filter));
                    
                    dropdown.innerHTML = '';
                    if (itemsToShow.length > 0) {
                        itemsToShow.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'custom-dropdown-item';
                            itemEl.textContent = item;
                            itemEl.addEventListener('mousedown', (e) => { 
                                e.preventDefault();
                                onSelect(item);
                                input.value = '';
                                dropdown.classList.add('hidden');
                            });
                            dropdown.appendChild(itemEl);
                        });
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.classList.add('hidden');
                    }
                };

                input.addEventListener('focus', () => renderDropdown(true));
                input.addEventListener('input', () => renderDropdown(false));
                input.addEventListener('blur', () => setTimeout(() => dropdown.classList.add('hidden'), 150));
                if(onAdd) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            onAdd();
                        }
                    });
                }
            };

            // Setup para XML
            addXmlTagBtn.addEventListener('click', addCurrentXmlTag);
            setupDropdown(xmlTagInput, xmlTagDropdown, () => xmlTags, 
                (tag) => { // onSelect
                    const start = mainEditor.selectionStart;
                    const end = mainEditor.selectionEnd;
                    const text = mainEditor.value;
                    const selectedText = text.substring(start, end);
                    const tagText = selectedText ? `<${tag}>\n${selectedText}\n</${tag}>` : `<${tag}>\n\n</${tag}>`;
                    const newCursorPosition = start + (selectedText ? tagText.length : tag.length + 3);
                    
                    mainEditor.value = text.substring(0, start) + tagText + text.substring(end);
                    mainEditor.focus();
                    mainEditor.setSelectionRange(newCursorPosition, newCursorPosition);
                    mainEditor.dispatchEvent(new Event('input', { bubbles: true }));
                },
                addCurrentXmlTag
            );

            // Setup para Var Library
            addVarLibraryBtn.addEventListener('click', addCurrentVarToLibrary);
            setupDropdown(varLibraryInput, varLibraryDropdown, () => varLibrary,
                (varName) => { // onSelect
                    const start = mainEditor.selectionStart;
                    const end = mainEditor.selectionEnd;
                    const text = mainEditor.value;
                    mainEditor.value = text.substring(0, start) + varName + text.substring(end);
                    mainEditor.focus();
                    mainEditor.setSelectionRange(start + varName.length, start + varName.length);
                    mainEditor.dispatchEvent(new Event('input', { bubbles: true }));
                },
                addCurrentVarToLibrary
            );

             // Setup para Tags do Prompt
            setupDropdown(tagsInput, tagsDropdown, getAllUniqueTags,
                (tag) => { // onSelect
                    const currentTags = [...tagsContainer.querySelectorAll('.prompt-tag span')].map(span => span.textContent);
                    if (!currentTags.includes(tag)) {
                        const tagEl = createTagEl(tag, false);
                        tagsContainer.appendChild(tagEl);
                    }
                    tagsInput.value = '';
                },
                () => { // onAdd
                    const tagName = tagsInput.value.trim().toLowerCase();
                    if (tagName) {
                        const newTag = tagName.startsWith('#') ? tagName : `#${tagName}`;
                        const currentTags = [...tagsContainer.querySelectorAll('.prompt-tag span')].map(span => span.textContent);
                        if (!currentTags.includes(newTag)) {
                            const tagEl = createTagEl(newTag, false);
                            tagsContainer.appendChild(tagEl);
                        }
                        tagsInput.value = '';
                    }
                }
            );
            
            // --- EVENTOS DO GERENCIADOR DE LISTAS ---
            listManagerBtn.addEventListener('click', () => {
                renderListManager();
                listManagerModal.classList.remove('hidden');
            });

            closeListManagerBtn.addEventListener('click', () => {
                listManagerModal.classList.add('hidden');
            });
            
            listManagerModal.addEventListener('click', (e) => {
                if (e.target === listManagerModal) {
                    listManagerModal.classList.add('hidden');
                }
            });

            listManagerModal.addEventListener('focusout', (e) => {
                const span = e.target;
                if (span.matches('.manager-tag span[contenteditable="true"]')) {
                    const parent = span.parentElement;
                    const oldVal = parent.dataset.value;
                    const newVal = span.textContent.trim();
                    const type = parent.dataset.type;
                    const category = parent.dataset.category;

                    if (newVal !== oldVal) {
                        updateListItem(type, oldVal, newVal, { category });
                    }
                }
            });

            listManagerModal.addEventListener('keydown', (e) => {
                const span = e.target;
                if (span.matches('.manager-tag span[contenteditable="true"]') && e.key === 'Enter') {
                    e.preventDefault();
                    span.blur();
                }
            });

            listManagerModal.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-tag-btn');
                const addModelBtn = e.target.closest('[data-action="add-model"]');

                if (removeBtn) {
                    const parent = removeBtn.parentElement;
                    const value = parent.dataset.value;
                    const type = parent.dataset.type;
                    const category = parent.dataset.category;

                    showModal(
                        'Confirm Deletion',
                        `Are you sure you want to delete the item "${value}"? This action cannot be undone.`,
                        [
                            { text: 'Cancel', className: 'action-button', onClick: async () => await hideModal },
                            { 
                                text: 'Delete', 
                                className: 'action-button bg-[--accent-red] text-white border-[--accent-red-hover] hover:bg-[--accent-red-hover]', 
                                onClick: async () => {
                                    let updatePrompts = false;
                                    switch (type) {
                                        case 'xml': xmlTags = xmlTags.filter(t => t !== value); saveXmlTagsToStorage(); break;
                                        case 'var': varLibrary = varLibrary.filter(t => t !== value); saveVarLibraryToStorage(); break;
                                        case 'llm-category': delete llmList[value]; saveLlmListToStorage(); populateLlmSelect(); break;
                                        case 'llm-model':
                                            if (llmList[category]) {
                                                llmList[category] = llmList[category].filter(m => m !== value);
                                                saveLlmListToStorage();
                                                updateGlobalList('llm_list', llmList);
                                                populateLlmSelect();
                                                updatePrompts = true;
                                            }
                                            break;
                                        case 'general': updatePrompts = true; break;
                                    }

                                    if (updatePrompts) {
                                        prompts.forEach(p => {
                                            if (type === 'llm-model' && p.llm === value) p.llm = 'generic';
                                            if (type === 'general' && p.tags) p.tags = p.tags.filter(t => t !== value);
                                        });
                                        savePromptsToStorage();
                                        await upsertItem('prompts', prompts);
                                        if (selectedVersionId) loadVersionIntoEditor(selectedVersionId);
                                        
                                    }
                                    
                                    renderListManager();
                                    hideModal();
                                }
                            }
                        ]
                    );
                } else if (addModelBtn) {
                    const category = addModelBtn.dataset.category;
                    const input = addModelBtn.previousElementSibling;
                    const modelName = input.value.trim();
                    if (modelName && llmList[category] && !llmList[category].includes(modelName)) {
                        llmList[category].push(modelName);
                        saveLlmListToStorage();
                        populateLlmSelect();
                        renderListManager();
                        input.value = '';
                    }
                }
            });

            addXmlTagManagerBtn.addEventListener('click', () => {
                const tagName = addXmlTagManagerInput.value.trim();
                if (tagName && !xmlTags.includes(tagName)) {
                    xmlTags.push(tagName);
                    saveXmlTagsToStorage();
                    addXmlTagManagerInput.value = '';
                    renderListManager();
                }
            });

            addVarLibraryManagerBtn.addEventListener('click', () => {
                let varName = addVarLibraryManagerInput.value.trim();
                if (varName) {
                    if (!varName.startsWith('{{') || !varName.endsWith('}}')) {
                        varName = `{{${varName.replace(/{{|}}/g, '')}}}`;
                    }
                    if (!varLibrary.includes(varName)) {
                        varLibrary.push(varName);
                        saveVarLibraryToStorage();
                        addVarLibraryManagerInput.value = '';
                        renderListManager();
                    }
                }
            });

            addLlmCategoryManagerBtn.addEventListener('click', () => {
                const categoryName = addLlmCategoryManagerInput.value.trim();
                if (categoryName && !llmList[categoryName]) {
                    llmList[categoryName] = [];
                    saveLlmListToStorage();
                    updateGlobalList('llm_list', llmList);
                    addLlmCategoryManagerInput.value = '';
                    renderListManager();
                    populateLlmSelect();
                }
            });

            // --- EVENTOS DO INPUT GALLERY ---
            inputGalleryBtn.addEventListener('click', () => {
                renderInputGallery();
                clearInputEditor(); // Começa com um editor limpo
                inputGalleryModal.classList.remove('hidden');
            });

            closeInputGalleryBtn.addEventListener('click', () => {
                inputGalleryModal.classList.add('hidden');
            });

            inputGalleryModal.addEventListener('click', (e) => {
                if (e.target === inputGalleryModal) {
                    inputGalleryModal.classList.add('hidden');
                }
            });

            addNewInputBtn.addEventListener('click', clearInputEditor);
            saveInputGalleryBtn.addEventListener('click', saveCurrentInput);

            inputGalleryList.addEventListener('click', (e) => {
                const item = e.target.closest('.input-gallery-item');
                const deleteBtn = e.target.closest('[data-action="delete-input"]');

                if (deleteBtn) {
                    e.stopPropagation();
                    const idToDelete = parseInt(deleteBtn.dataset.id, 10);
                    deleteInputFromGallery(idToDelete);
                } else if (item) {
                    const idToLoad = parseInt(item.dataset.id, 10);
                    loadInputForEditing(idToLoad);
                }
            });
            
            // --- SETUP DO DROPDOWN ADD INPUT ---
            setupDropdown(addInputInput, addInputDropdown, 
                () => inputGallery.map(i => i.name), // library function
                (name) => { // onSelect function
                    const selectedInput = inputGallery.find(i => i.name === name);
                    if (selectedInput) {
                        const start = mainEditor.selectionStart;
                        const end = mainEditor.selectionEnd;
                        const text = mainEditor.value;
                        const contentToInsert = selectedInput.content;
                        mainEditor.value = text.substring(0, start) + contentToInsert + text.substring(end);
                        mainEditor.focus();
                        mainEditor.setSelectionRange(start + contentToInsert.length, start + contentToInsert.length);
                        // Dispara o evento de input manualmente para atualizar tudo
                        mainEditor.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                },
                null // onAdd (não faz nada ao pressionar Enter)
            );

            // --- EVENTO DO SNIPPET COPY ---
            snippetButtonsOverlay.addEventListener('click', (e) => {
                const button = e.target.closest('.copy-snippet-btn');
                if (button) {
                    const index = parseInt(button.dataset.snippetIndex, 10);
                    if (snippets[index]) {
                        const textToCopy = snippets[index].content;
                        
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                            button.classList.add('copied');
                            setTimeout(() => {
                                button.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                                button.classList.remove('copied');
                            }, 1500);
                        } catch (err) {
                            console.error('Failed to copy snippet:', err);
                        }
                        document.body.removeChild(textArea);
                    }
                }
            });


            // --- Evento do Mapa de Navegação ---
            navigationMap.addEventListener('click', (e) => {
                const target = e.target.closest('.nav-map-tag');
                if (target) {
                    const index = parseInt(target.dataset.index, 10);
                    mainEditor.focus();
                    mainEditor.setSelectionRange(index, index);
                }
            });

            // --- EVENTOS DO NODE FLOW ---
            const zoom = d3.zoom()
                .scaleExtent([0.2, 2])
                .on("zoom", (event) => {
                    currentTransform = event.transform;
                    nodeFlowContent.style.transform = `translate(${currentTransform.x}px, ${currentTransform.y}px) scale(${currentTransform.k})`;
                    d3.select("#connections-group").attr("transform", null); // Remove transform do grupo!
                    renderFlowConnections();
                });
                
            d3.select("#node-flow-canvas")
                .call(zoom);

            nodeFlowBtn.addEventListener('click', () => {
                populateProjectList(nodeFlowProjectFilter);
                renderNodeFlowPrompts();
                renderSavedFlowsList();
                nodeFlowModal.classList.remove('hidden');
            });
            closeNodeFlowBtn.addEventListener('click', () => nodeFlowModal.classList.add('hidden'));
            nodeFlowModal.addEventListener('click', (e) => {
                if (e.target === nodeFlowModal) {
                    nodeFlowModal.classList.add('hidden');
                }
            });
            nodeFlowProjectFilter.addEventListener('change', renderNodeFlowPrompts);

        saveFlowBtn.addEventListener('click', () => {
                showModal('Save Flow', 'Enter a name for this flow:', [
                    { text: 'Cancel', className: 'action-button', onClick: hideModal },
            { text: 'Save', className: 'action-button primary', onClick: async () => {
                        const flowName = confirmModalInput.value.trim();
                        if (flowName) {
                            const existing = savedFlows.findIndex(f => f.name === flowName);
                            const flowData = { name: flowName, nodes: flowNodes, connections: flowConnections };
                            if (existing > -1) {
                                savedFlows[existing] = flowData;
                            } else {
                                savedFlows.push(flowData);
                            }
                            saveFlowsToStorage();
                await upsertItem('node_flows', flowData);
                            renderSavedFlowsList();
                            savedFlowsDropdown.value = flowName;
                            hideModal();
                        }
                    }}
                ], { showInput: true, inputPlaceholder: 'My awesome flow...' });
            });

            savedFlowsDropdown.addEventListener('change', (e) => {
                const flowName = e.target.value;
                if (flowName) {
                    loadFlow(flowName);
                }
            });

            nodeFlowPromptList.addEventListener('dragstart', (e) => {
                const target = e.target.closest('.node-flow-prompt-card');
                if(target) {
                    e.dataTransfer.setData('text/plain', target.dataset.versionId);
                    e.dataTransfer.effectAllowed = 'copy';
                }
            });

            nodeFlowCanvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            nodeFlowCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const versionId = parseInt(e.dataTransfer.getData('text/plain'), 10);
                const canvasRect = nodeFlowCanvas.getBoundingClientRect();
                
                const x = (e.clientX - canvasRect.left - currentTransform.x) / currentTransform.k;
                const y = (e.clientY - canvasRect.top - currentTransform.y) / currentTransform.k;

                const newNode = {
                    id: crypto.randomUUID(),
                    promptId: versionId,
                    x: x - 140, // Centraliza o card no drop
                    y: y - 80,
                };
                flowNodes.push(newNode);
                renderFlowNodes();
            });
            
            nodeFlowCanvas.addEventListener('mousedown', (e) => {
                if (e.target.closest('.flow-node')) return;
                nodeFlowCanvas.style.cursor = 'grabbing';
            });
            
            nodeFlowCanvas.addEventListener('mouseup', () => {
                 nodeFlowCanvas.style.cursor = 'grab';
            });

            nodeFlowContent.addEventListener('mousedown', (e) => {
                const nodeEl = e.target.closest('.flow-node');
                const connectorEl = e.target.closest('.connector');

                if (connectorEl) {
                    e.stopPropagation(); 
                    isDrawingConnection = true;
                    connectionStartNodeId = connectorEl.dataset.nodeId;
                    
                    const startNodeEl = document.getElementById(`flow-node-${connectionStartNodeId}`);
                    const startNodeData = flowNodes.find(n => n.id == connectionStartNodeId);

                    if (startNodeData) {
                        const sourceX = startNodeData.x + startNodeEl.offsetWidth;
                        const sourceY = startNodeData.y + startNodeEl.offsetHeight / 2;
                        const [startX, startY] = currentTransform.apply([sourceX, sourceY]);

                        tempLine = d3.select("#node-flow-connections")
                            .append('path')
                            .attr('d', `M ${startX} ${startY} C ${startX} ${startY} ${startX} ${startY} ${startX} ${startY}`)
                            .attr('class', 'connection-line')
                            .style('stroke-dasharray', '5, 5');
                    }

                } else if (nodeEl) {
                    e.stopPropagation(); 
                    isDraggingNode = true;
                    const nodeId = nodeEl.dataset.nodeId;
                    const nodeData = flowNodes.find(n => n.id == nodeId);

                    const moveHandler = (moveEvent) => {
                        if (!isDraggingNode) return;
                        nodeData.x += moveEvent.movementX / currentTransform.k;
                        nodeData.y += moveEvent.movementY / currentTransform.k;
                        nodeEl.style.left = `${nodeData.x}px`;
                        nodeEl.style.top = `${nodeData.y}px`;
                        renderFlowConnections();
                    };

                    const upHandler = () => {
                        isDraggingNode = false;
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('mouseup', upHandler);
                    };

                    document.addEventListener('mousemove', moveHandler);
                    document.addEventListener('mouseup', upHandler);
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDrawingConnection || !tempLine) return;
                const canvasRect = nodeFlowCanvas.getBoundingClientRect();
                const startNodeEl = document.getElementById(`flow-node-${connectionStartNodeId}`);
                const startNodeData = flowNodes.find(n => n.id == connectionStartNodeId);

                if (startNodeData && startNodeEl) {
                    const sourceX = startNodeData.x + startNodeEl.offsetWidth;
                    const sourceY = startNodeData.y + startNodeEl.offsetHeight / 2;
                    const [startX, startY] = currentTransform.apply([sourceX, sourceY]);

                    const endX = e.clientX - canvasRect.left;
                    const endY = e.clientY - canvasRect.top;
                    
                    tempLine.attr('d', `M ${startX} ${startY} C ${startX + 60} ${startY} ${endX - 60} ${endY} ${endX} ${endY}`);
                }
            });

            document.addEventListener('mouseup', (e) => {
                if (isDrawingConnection) {
                    const targetNodeEl = e.target.closest('.flow-node');
                    if (targetNodeEl && targetNodeEl.dataset.nodeId !== connectionStartNodeId) {
                        const targetNodeId = targetNodeEl.dataset.nodeId;
                        const exists = flowConnections.some(c => c.source == connectionStartNodeId && c.target == targetNodeId);
                        if (!exists) {
                            flowConnections.push({ source: connectionStartNodeId, target: targetNodeId });
                        }
                    }
                    if(tempLine) tempLine.remove();
                    isDrawingConnection = false;
                    connectionStartNodeId = null;
                    tempLine = null;
                    renderFlowConnections();
                }
            });

            nodeFlowContent.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const nodeEl = e.target.closest('.flow-node');
                if (nodeEl) {
                    const nodeId = nodeEl.dataset.nodeId;
                    flowNodes = flowNodes.filter(n => n.id != nodeId);
                    flowConnections = flowConnections.filter(c => c.source != nodeId && c.target != nodeId);
                    renderFlowNodes();
                    renderFlowConnections();
                }
            });
            
            nodeFlowConnections.addEventListener('contextmenu', (e) => {
                 e.preventDefault();
                 const lineEl = e.target.closest('.connection-line');
                 if (lineEl) {
                    const source = lineEl.dataset.source;
                    const target = lineEl.dataset.target;
                    flowConnections = flowConnections.filter(c => !(c.source == source && c.target == target));
                    renderFlowConnections();
                 }
            });


            // --- Atalhos do teclado ---
            document.addEventListener('keydown', (e) => {
                // Atalho para abrir/fechar busca
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    const isVisible = findReplaceBar.classList.contains('visible');
                    toggleFindReplaceBar(!isVisible);
                }
                // Atalho para fechar modais e busca com ESC
                if (e.key === "Escape") {
                    if (!readModeModal.classList.contains('hidden')) {
                        toggleReadMode();
                    }
                    if (findReplaceBar.classList.contains('visible')) {
                        toggleFindReplaceBar(false);
                    }
                    if (!dependencyGraphModal.classList.contains('hidden')) {
                        dependencyGraphModal.classList.add('hidden');
                    }
                    if (!listManagerModal.classList.contains('hidden')) {
                        listManagerModal.classList.add('hidden');
                    }
                    if (!inputGalleryModal.classList.contains('hidden')) {
                        inputGalleryModal.classList.add('hidden');
                    }
                    if (!nodeFlowModal.classList.contains('hidden')) {
                        nodeFlowModal.classList.add('hidden');
                    }
                }
            });

            toggleCommentsBtn.addEventListener('click', () => {
                commentsSection.classList.toggle('hidden');
            });

            // --- INICIALIZAÇÃO ---
            const initializeApp = async () => {
                await loadDataFromSupabase(); // Espera os dados do Supabase carregarem
                populateLlmSelect();
                clearEditorForNewPrompt();
            };

            initializeApp();
        });
    </script>
</body>
</html>